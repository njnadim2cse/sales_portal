<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="quotation_portal" name="Quotation Portal">
        <t t-call="website.layout">
            <t t-set="head">
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
                <style>
                    /* Enhanced Sidebar Design */
                    .dashboard-sidebar {
                        position: fixed;
                        top: 70px;
                        left: 0;
                        height: calc(100vh - 70px);
                        width: 280px;
                        background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
                        border-right: none;
                        box-shadow: 4px 0 20px rgba(0,0,0,0.1);
                        z-index: 1000;
                        padding-top: 20px;
                        overflow-y: auto;
                        transition: all 0.3s ease;
                    }

                    .dashboard-sidebar .sidebar-header {
                        padding: 0 25px 20px;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                        margin-bottom: 15px;
                    }

                    .dashboard-sidebar .sidebar-header h4 {
                        color: white;
                        font-weight: 600;
                        margin: 0;
                        font-size: 1.2rem;
                    }

                    .dashboard-sidebar .list-group-item {
                        border: none;
                        border-radius: 12px;
                        padding: 16px 20px;
                        margin: 4px 15px;
                        font-weight: 500;
                        color: rgba(255,255,255,0.9);
                        background: transparent;
                        transition: all 0.3s ease;
                        border-left: 3px solid transparent;
                    }

                    .dashboard-sidebar .list-group-item:hover {
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border-left-color: #e74c3c;
                        transform: translateX(5px);
                    }

                    .dashboard-sidebar .list-group-item.active {
                        background: rgba(255,255,255,0.15);
                        color: white;
                        border-left-color: #e74c3c;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }

                    .dashboard-sidebar .list-group-item i {
                        width: 20px;
                        text-align: center;
                        margin-right: 12px;
                        font-size: 1.1rem;
                    }

                    .dashboard-content {
                        margin-left: 300px;
                        padding: 30px;
                        min-height: calc(100vh - 70px);
                        background: #f8fafc;
                    }

                    /* Enhanced Card Design */
                    .card {
                        border: none;
                        border-radius: 16px;
                        box-shadow: 0 4px 25px rgba(0,0,0,0.08);
                        margin-bottom: 25px;
                        overflow: hidden;
                    }

                    .card-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 20px 25px;
                    }

                    .card-header h2 {
                        margin: 0;
                        font-weight: 600;
                        font-size: 1.5rem;
                    }

                    /* Quotation Stats */
                    .quote-stats-card {
                        background: white;
                        border-radius: 16px;
                        padding: 25px;
                        box-shadow: 0 4px 25px rgba(0,0,0,0.08);
                        text-align: center;
                        transition: all 0.3s ease;
                        border: 1px solid #f1f3f4;
                    }

                    .quote-stats-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                    }

                    .quote-stats-card .stats-number {
                        font-size: 2rem;
                        font-weight: 700;
                        color: #2c3e50;
                        margin-bottom: 5px;
                    }

                    .quote-stats-card .stats-label {
                        font-size: 0.9rem;
                        color: #7f8c8d;
                        font-weight: 500;
                    }

                    /* Quotation Items */
                    .quote-item {
                        border: 1px solid #e9ecef;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 15px;
                        background: white;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                    }

                    .quote-item:hover {
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        transform: translateY(-2px);
                    }

                    /* Compact Capsule Status Badges */
                    .quote-status {
                        display: inline-block;
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 0.7rem;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        min-width: 90px;
                        text-align: center;
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    }

                    .status-draft {
                        background: #ffd166;
                        color: #7d5a29;
                    }

                    .status-sent {
                        background: #6a89cc;
                        color: white;
                    }

                    .status-sale {
                        background: #27ae60;
                        color: white;
                    }

                    .status-confirmed {
                        background: #27ae60;
                        color: white;
                    }

                    .status-done {
                        background: #27ae60;
                        color: white;
                    }

                    .status-cancel {
                        background: #e74c3c;
                        color: white;
                    }

                    /* Enhanced Buttons */
                    .btn-primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        border-radius: 10px;
                        padding: 12px 24px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    }

                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                    }

                    /* Order Line Items */
                    .order-line-item {
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 10px;
                        margin-bottom: 15px;
                    }

                    .order-line-item .remove-btn {
                        margin-left: auto;
                    }

                    .order-line-item h6 {
                        color: #2c3e50;
                        font-weight: 600;
                    }

                    /* Form Enhancements */
                    .form-control {
                        border-radius: 10px;
                        border: 2px solid #e9ecef;
                        padding: 12px 16px;
                        transition: all 0.3s ease;
                    }

                    .form-control:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                    }

                    .form-label {
                        font-weight: 600;
                        color: #2c3e50;
                        margin-bottom: 8px;
                    }

                    .section-header {
                        color: #2c3e50;
                        font-weight: 600;
                        margin-bottom: 20px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #3498db;
                    }

                    /* Success Message */
                    .success-message {
                        position: fixed;
                        top: 80px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 9999;
                        min-width: 400px;
                        max-width: 600px;
                        background: linear-gradient(135deg, #27ae60, #2ecc71);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 12px;
                        box-shadow: 0 10px 40px rgba(39, 174, 96, 0.4);
                        animation: slideDown 0.5s ease-out;
                    }

                    .success-message i {
                        font-size: 1.5rem;
                        margin-right: 15px;
                    }

                    @keyframes slideDown {
                        from {
                            opacity: 0;
                            transform: translateX(-50%) translateY(-30px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                    }

                    @media (max-width: 768px) {
                        .success-message {
                            min-width: 90%;
                            left: 5%;
                            transform: none;
                        }
                    }

                    /* Search Dropdown Styles */
                    .search-dropdown-container {
                        position: relative;
                    }

                    .search-suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        max-height: 300px;
                        overflow-y: auto;
                        z-index: 1060;
                        border: 1px solid #dee2e6;
                        border-radius: 0.375rem;
                        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                        display: none;
                    }

                    .search-suggestions .list-group-item {
                        border: none;
                        border-bottom: 1px solid #f8f9fa;
                        padding: 12px 16px;
                        cursor: pointer;
                    }

                    .search-suggestions .list-group-item:hover {
                        background-color: #f8f9fa;
                    }

                    .search-suggestions .list-group-item:last-child {
                        border-bottom: none;
                    }

                    .search-dropdown-input {
                        border-radius: 0.375rem !important;
                    }

                    .clear-search-btn {
                        border-radius: 0 0.375rem 0.375rem 0 !important;
                    }

                    @media (max-width: 1024px) {
                        .dashboard-sidebar {
                            width: 250px;
                        }
                        .dashboard-content {
                            margin-left: 270px;
                        }
                    }

                    @media (max-width: 768px) {
                        .dashboard-sidebar {
                            width: 100%;
                            height: auto;
                            position: relative;
                            top: 0;
                        }
                        
                        .dashboard-content {
                            margin-left: 0;
                            padding: 20px 15px;
                        }
                    }
                </style>
            </t>
            
            <div class="container-fluid">
                <div class="row">
                    <!-- Enhanced Sidebar -->
                    <div class="dashboard-sidebar">
                        <div class="sidebar-header">
                            <h4>Sales Management</h4>
                        </div>
                        <div class="list-group" id="sidebarMenu">
                            <!-- Dashboard - Always visible -->
                            <a href="/sales_management" class="list-group-item list-group-item-action">
                                <i class="fa fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                            
                            <!-- Sales Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_sales_portal">
                                <a href="/sales_management/sales" class="list-group-item list-group-item-action">
                                    <i class="fa fa-briefcase me-2"></i> Sales
                                </a>
                            </t>
                            <!-- Service Portal - Conditionally visible -->
                             <t t-if="request.env.user.use_service_portal">
                                <a href="/sales_management/service" class="list-group-item list-group-item-action">
                                    <i class="fa fa-concierge-bell me-2"></i> Service
                                </a>
                            </t>
                            
                            <!-- Contacts Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_contact_portal">
                                <a href="/sales_management/contacts" class="list-group-item list-group-item-action">
                                    <i class="fa fa-users me-2"></i> Contacts
                                </a>
                            </t>
                            
                            <!-- Quotation Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_quotation_portal">
                                <a href="/sales_management/quotation" class="list-group-item list-group-item-action active">
                                    <i class="fa fa-file-invoice-dollar me-2"></i> Quotation
                                </a>
                            </t>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="dashboard-content col">
                        <!-- Success Message -->
                        <t t-if="message">
                            <div class="success-message" id="successMessage">
                                <i class="fa fa-check-circle"></i>
                                <strong t-esc="message"/>
                            </div>
                        </t>

                        <!-- Search and Filter Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <form method="get" action="/sales_management/quotation" class="row g-3 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Search</label>
                                        <input type="text" name="search" class="form-control" placeholder="Search by order number, customer, status..." 
                                            t-att-value="search_term or ''"/>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Date From</label>
                                        <input type="date" name="date_from" class="form-control" t-att-value="date_from or ''"/>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Date To</label>
                                        <input type="date" name="date_to" class="form-control" t-att-value="date_to or ''"/>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fa fa-filter me-2"></i>Filter
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 class="mb-1">Quotation Management</h2>
                                <p class="text-muted mb-0">Create and manage your sales quotations</p>
                            </div>
                            <a href="/sales_management/quotation/create" class="btn btn-primary">
                                <i class="fa fa-plus me-2"></i>Create Quotation
                            </a>
                        </div>

                        <!-- Quotations List -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="mb-0">All Quotations</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Order Number</th>
                                                <th>Date</th>
                                                <th>Customer</th>
                                                <th>Total Amount</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="quotations" t-as="quote">
                                                <tr>
                                                    <td>
                                                        <strong t-esc="quote.name"/>
                                                    </td>
                                                    <td t-esc="quote.date_order"/>
                                                    <td t-esc="quote.partner_id.complete_name"/>
                                                    <td>
                                                        <strong t-esc="'${:,.2f}'.format(quote.amount_total)"/>
                                                    </td>
                                                    <td>
                                                        <span class="quote-status" t-att-class="'status-' + quote.state">
                                                            <t t-if="quote.state == 'draft'">Quotation</t>
                                                            <t t-elif="quote.state == 'sent'">Quotation Sent</t>
                                                            <t t-elif="quote.state == 'sale'">Sales Order</t>
                                                            <t t-elif="quote.state == 'cancel'">Cancelled</t>
                                                            <t t-else=""><t t-esc="quote.state.title()"/></t>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <button type="button" class="btn btn-sm btn-outline-primary view-quote-btn" 
                                                                    t-att-data-quote-id="quote.id" title="View">
                                                                <i class="fa fa-eye"></i>
                                                            </button>
                                                            <a t-att-href="'/sales_management/quotation/download_pdf/' + str(quote.id)" 
                                                                class="btn btn-sm btn-outline-secondary" 
                                                                title="Download PDF">
                                                                <i class="fa fa-download"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </t>
                                            <t t-if="not quotations">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted py-5">
                                                        <i class="fa fa-file-invoice-dollar fa-3x mb-3 text-muted"></i>
                                                        <p class="mb-2">No quotations found</p>
                                                        <a href="/sales_management/quotation/create" class="btn btn-primary">
                                                            Create your first quotation
                                                        </a>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quotation View Modal -->
            <div class="modal fade" id="quotationViewModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Quotation Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="quotationViewContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
            <![CDATA[
                // Auto-hide success message function
                function autoHideSuccessMessage() {
                    const successMessage = document.getElementById('successMessage');
                    if (successMessage) {
                        // Make sure it's visible
                        successMessage.style.display = 'block';
                        successMessage.style.opacity = '1';
                        
                        setTimeout(function() {
                            successMessage.style.opacity = '0';
                            successMessage.style.transition = 'opacity 0.5s ease-out';
                            
                            setTimeout(function() {
                                if (successMessage && successMessage.parentNode) {
                                    successMessage.remove();
                                }
                            }, 500);
                        }, 5000);
                    }
                }

                document.addEventListener("DOMContentLoaded", function () {
                    // Initialize auto-hide for success message
                    autoHideSuccessMessage();

                    // Initialize sidebar menu
                    const menuItems = document.querySelectorAll("#sidebarMenu a");
                    const currentPath = window.location.pathname;

                    menuItems.forEach(item => {
                        item.classList.remove("active");
                        if (item.getAttribute("href") === currentPath) {
                            item.classList.add("active");
                        }
                    });

                    // Add event listeners for view buttons - FIXED
                    document.querySelectorAll('.view-quote-btn').forEach(button => {
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const quoteId = this.getAttribute('data-quote-id');
                            if (quoteId) {
                                viewQuotation(quoteId);
                            }
                        });
                    });
                });

                // Make function globally accessible
                window.viewQuotation = function(quoteId) {
                    // Show loading state
                    const modalContent = document.getElementById('quotationViewContent');
                    if (!modalContent) {
                        console.error('Quotation modal content not found');
                        return;
                    }
                    
                    modalContent.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div><p class="mt-2">Loading quotation details...</p></div>';
                    
                    // Show modal FIRST
                    const modalElement = document.getElementById('quotationViewModal');
                    if (!modalElement) {
                        console.error('Quotation modal element not found');
                        return;
                    }
                    
                    // Use Bootstrap modal if available
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        // Fallback
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                    }
                    
                    // Then load content
                    fetch('/sales_management/quotation/view/' + quoteId)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok: ' + response.status);
                            }
                            return response.text();
                        })
                        .then(html => {
                            modalContent.innerHTML = html;
                        })
                        .catch(error => {
                            console.error('Error loading quotation:', error);
                            modalContent.innerHTML = '<div class="alert alert-danger">Error loading quotation details. Please try again.</div>';
                        });
                };

                // Close function for quotation modal
                window.closeQuotationModal = function() {
                    const modalElement = document.getElementById('quotationViewModal');
                    if (!modalElement) return;
                    
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    } else {
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                    }
                };
            ]]>
            </script>
        </t>
    </template>

    <template id="quotation_form" name="Quotation Creation Form">
        <t t-call="website.layout">
            <t t-set="head">
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
                <style>
                    /* Enhanced Sidebar Design - SAME AS CONTACTS */
                    .dashboard-sidebar {
                        position: fixed;
                        top: 70px;
                        left: 0;
                        height: calc(100vh - 70px);
                        width: 280px;
                        background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
                        border-right: none;
                        box-shadow: 4px 0 20px rgba(0,0,0,0.1);
                        z-index: 1000;
                        padding-top: 20px;
                        overflow-y: auto;
                        transition: all 0.3s ease;
                    }

                    .dashboard-sidebar .sidebar-header {
                        padding: 0 25px 20px;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                        margin-bottom: 15px;
                    }

                    .dashboard-sidebar .sidebar-header h4 {
                        color: white;
                        font-weight: 600;
                        margin: 0;
                        font-size: 1.2rem;
                    }

                    .dashboard-sidebar .list-group-item {
                        border: none;
                        border-radius: 12px;
                        padding: 16px 20px;
                        margin: 4px 15px;
                        font-weight: 500;
                        color: rgba(255,255,255,0.9);
                        background: transparent;
                        transition: all 0.3s ease;
                        border-left: 3px solid transparent;
                    }

                    .dashboard-sidebar .list-group-item:hover {
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border-left-color: #e74c3c;
                        transform: translateX(5px);
                    }

                    .dashboard-sidebar .list-group-item.active {
                        background: rgba(255,255,255,0.15);
                        color: white;
                        border-left-color: #e74c3c;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }

                    .dashboard-sidebar .list-group-item i {
                        width: 20px;
                        text-align: center;
                        margin-right: 12px;
                        font-size: 1.1rem;
                    }

                    .dashboard-content {
                        margin-left: 300px;
                        padding: 30px;
                        min-height: calc(100vh - 70px);
                        background: #f8fafc;
                    }

                    /* Search Dropdown Styles */
                    .search-dropdown-container {
                        position: relative;
                    }

                    .search-suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        max-height: 300px;
                        overflow-y: auto;
                        z-index: 1060;
                        border: 1px solid #dee2e6;
                        border-radius: 0.375rem;
                        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                        display: none;
                    }

                    .search-suggestions .list-group-item {
                        border: none;
                        border-bottom: 1px solid #f8f9fa;
                        padding: 12px 16px;
                        cursor: pointer;
                    }

                    .search-suggestions .list-group-item:hover {
                        background-color: #f8f9fa;
                    }

                    .search-suggestions .list-group-item:last-child {
                        border-bottom: none;
                    }

                    .search-dropdown-input {
                        border-radius: 0.375rem !important;
                    }

                    .clear-search-btn {
                        border-radius: 0 0.375rem 0.375rem 0 !important;
                    }

                    @media (max-width: 1024px) {
                        .dashboard-sidebar {
                            width: 250px;
                        }
                        .dashboard-content {
                            margin-left: 270px;
                        }
                    }

                    @media (max-width: 768px) {
                        .dashboard-sidebar {
                            width: 100%;
                            height: auto;
                            position: relative;
                            top: 0;
                        }
                        
                        .dashboard-content {
                            margin-left: 0;
                            padding: 20px 15px;
                        }
                    }
                </style>
            </t>
            
            <div class="container-fluid">
                <div class="row">
                    <!-- Enhanced Sidebar -->
                    <div class="dashboard-sidebar">
                        <div class="sidebar-header">
                            <h4>Sales Management</h4>
                        </div>
                        <div class="list-group" id="sidebarMenu">
                            <!-- Dashboard - Always visible -->
                            <a href="/sales_management" class="list-group-item list-group-item-action">
                                <i class="fa fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                            
                            <!-- Sales Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_sales_portal">
                                <a href="/sales_management/sales" class="list-group-item list-group-item-action">
                                    <i class="fa fa-briefcase me-2"></i> Sales
                                </a>
                            </t>
                            <!-- Service Portal - Conditionally visible -->
                             <t t-if="request.env.user.use_service_portal">
                                <a href="/sales_management/service" class="list-group-item list-group-item-action">
                                    <i class="fa fa-concierge-bell me-2"></i> Service
                                </a>
                            </t>
                            
                            <!-- Contacts Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_contact_portal">
                                <a href="/sales_management/contacts" class="list-group-item list-group-item-action">
                                    <i class="fa fa-users me-2"></i> Contacts
                                </a>
                            </t>
                            
                            <!-- Quotation Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_quotation_portal">
                                <a href="/sales_management/quotation" class="list-group-item list-group-item-action active">
                                    <i class="fa fa-file-invoice-dollar me-2"></i> Quotation
                                </a>
                            </t>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="dashboard-content col">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 class="mb-1">Create Quotation</h2>
                                <p class="text-muted mb-0">Create a new sales quotation</p>
                            </div>
                            <a href="/sales_management/quotation" class="btn btn-secondary">
                                <i class="fa fa-arrow-left me-2"></i>Back to Quotations
                            </a>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="mb-0">Quotation Information</h2>
                            </div>
                            <div class="card-body">
                                <form method="post" action="/sales_management/quotation/submit" class="needs-validation" novalidate="novalidate" id="quotationForm">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                                    <!-- Basic Information -->
                                    <div class="mb-4">
                                        <h5 class="section-header">Basic Information</h5>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Customer *</label>
                                                <div id="customer-search-container"></div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Pricelist</label>
                                                <div class="input-group">
                                                    <input type="text" id="pricelist-display" class="form-control" readonly="readonly" placeholder="Auto-filled from customer"/>
                                                    <input type="hidden" id="pricelist-id" name="pricelist_id"/>
                                                    <span class="input-group-text" id="currency-symbol"></span>
                                                </div>
                                                <small class="text-muted">Auto-filled from customer's pricelist</small>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Quotation Date *</label>
                                                <input type="date" class="form-control" name="date_order" required="required" t-att-value="today"/>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Order Lines -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="section-header mb-0">Order Lines</h5>
                                            <button type="button" class="btn btn-outline-primary" onclick="addOrderLine()">
                                                <i class="fa fa-plus me-2"></i>Add Product
                                            </button>
                                        </div>
                                        <div id="order-lines-container">
                                            <!-- Order lines will be added here -->
                                        </div>
                                    </div>

                                    <!-- Total Amount -->
                                    <div class="total-amount-section">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h5 class="mb-0">Total Amount</h5>
                                                <p class="text-muted mb-0">Calculated automatically from order lines</p>
                                            </div>
                                            <div class="col-md-6 text-end">
                                                <h3 class="text-primary mb-0" id="total-amount">$0.00</h3>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-3 pt-4 border-top">
                                        <button type="submit" class="btn btn-primary px-5">
                                            <i class="fa fa-save me-2"></i>Create Quotation
                                        </button>
                                        <a href="/sales_management/quotation" class="btn btn-outline-secondary px-4">Cancel</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
            <![CDATA[
                // Enhanced Search Dropdown Component for Odoo 19
                class SearchDropdown {
                    constructor(config) {
                        this.config = config;
                        this.state = {
                            searchTerm: "",
                            showSuggestions: false,
                            filteredItems: [],
                            selectedItem: null,
                            isLoading: false
                        };
                        this.init();
                    }

                    init() {
                        this.createHTML();
                        this.bindEvents();
                    }

                    createHTML() {
                        const container = this.config.container;
                        const placeholder = this.config.placeholder || 'Search...';
                        const name = this.config.name;
                        
                        container.innerHTML = `
                            <div class="search-dropdown-container position-relative">
                                <div class="input-group">
                                    <input type="text" 
                                        class="form-control search-dropdown-input" 
                                        placeholder="${placeholder}" 
                                        autocomplete="off">
                                    <input type="hidden" name="${name}" class="selected-value">
                                    <button class="btn btn-outline-secondary clear-search-btn" type="button" style="display: none;">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                <div class="search-suggestions" style="display: none;">
                                    <div class="list-group"></div>
                                </div>
                            </div>
                        `;
                        
                        this.elements = {
                            container: container.querySelector('.search-dropdown-container'),
                            input: container.querySelector('.search-dropdown-input'),
                            hiddenInput: container.querySelector('.selected-value'),
                            suggestions: container.querySelector('.search-suggestions'),
                            clearBtn: container.querySelector('.clear-search-btn'),
                            list: container.querySelector('.list-group')
                        };
                    }

                    bindEvents() {
                        const self = this;
                        
                        // Input events
                        this.elements.input.addEventListener('input', function(ev) { 
                            self.onSearchChange(ev); 
                        });
                        
                        this.elements.input.addEventListener('focus', function() { 
                            self.onSearchFocus(); 
                        });
                        
                        // Blur event with delay to allow click on suggestions
                        this.elements.input.addEventListener('blur', function() { 
                            setTimeout(() => {
                                self.hideSuggestions();
                            }, 200);
                        });
                        
                        // Clear button
                        this.elements.clearBtn.addEventListener('click', function() { 
                            self.clearSearch(); 
                        });
                        
                        // Keyboard navigation
                        this.elements.input.addEventListener('keydown', function(ev) {
                            if (ev.key === 'Enter') {
                                ev.preventDefault();
                                if (self.state.filteredItems.length > 0) {
                                    self.onItemSelect(self.state.filteredItems[0]);
                                }
                            } else if (ev.key === 'Escape') {
                                self.hideSuggestions();
                            } else if (ev.key === 'ArrowDown') {
                                ev.preventDefault();
                                self.focusNextItem();
                            } else if (ev.key === 'ArrowUp') {
                                ev.preventDefault();
                                self.focusPreviousItem();
                            }
                        });
                    }

                    async onSearchChange(ev) {
                        const searchTerm = ev.target.value;
                        this.state.searchTerm = searchTerm;
                        
                        // Show/hide clear button
                        this.elements.clearBtn.style.display = searchTerm ? 'block' : 'none';

                        // If field is cleared manually, clear the hidden input
                        if (searchTerm.length === 0) {
                            this.elements.hiddenInput.value = '';
                            await this.loadAllItems();
                            this.showSuggestions();
                        } else if (searchTerm.length >= 1) {
                            await this.loadSuggestions(searchTerm);
                            this.showSuggestions();
                        }
                    }

                    async onSearchFocus() {
                        // Show all items when clicking on empty field
                        if (!this.state.searchTerm) {
                            await this.loadAllItems();
                            this.showSuggestions();
                        } else if (this.state.filteredItems.length > 0) {
                            this.showSuggestions();
                        }
                    }

                    async loadAllItems() {
                        await this.loadSuggestions('');
                    }

                    async loadSuggestions(searchTerm) {
                        if (this.state.isLoading) return;
                        
                        this.state.isLoading = true;
                        this.showLoadingState();
                        
                        try {
                            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                            
                            // Prepare request data
                            const requestData = {
                                jsonrpc: "2.0",
                                method: "call",
                                params: {
                                    search_term: searchTerm
                                }
                            };
                            
                            // Check if we need to include category_id in the request
                            if (this.config.searchUrl.includes('products_by_category')) {
                                // Extract category_id from URL if present
                                const url = new URL(this.config.searchUrl, window.location.origin);
                                const categoryId = url.searchParams.get('category_id');
                                if (categoryId) {
                                    requestData.params.category_id = categoryId;
                                }
                            }
                            
                            const response = await fetch(this.config.searchUrl.split('?')[0], { // Remove query params from URL
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': csrfToken
                                },
                                body: JSON.stringify(requestData)
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            // Handle Odoo JSON-RPC response format
                            if (data.result) {
                                this.state.filteredItems = data.result.items || [];
                            } else if (data.items) {
                                this.state.filteredItems = data.items || [];
                            } else {
                                this.state.filteredItems = [];
                            }
                            
                            this.renderSuggestions();
                            
                        } catch (error) {
                            console.error('Error loading suggestions:', error);
                            this.state.filteredItems = [];
                            this.renderSuggestions();
                        } finally {
                            this.state.isLoading = false;
                        }
                    }

                    showLoadingState() {
                        this.elements.list.innerHTML = '<div class="list-group-item text-center text-muted"><i class="fa fa-spinner fa-spin me-2"></i>Loading...</div>';
                    }

                    renderSuggestions() {
                        const displayField = this.config.displayField || 'name';
                        const secondaryField = this.config.secondaryField;
                        this.elements.list.innerHTML = '';

                        if (this.state.filteredItems.length === 0) {
                            this.elements.list.innerHTML = '<div class="list-group-item text-muted text-center"><i class="fa fa-search me-2"></i>No results found</div>';
                            return;
                        }

                        const self = this;
                        this.state.filteredItems.forEach(function(item, index) {
                            const itemElement = document.createElement('button');
                            itemElement.type = 'button';
                            itemElement.className = 'list-group-item list-group-item-action';
                            itemElement.setAttribute('data-index', index);
                            
                            let secondaryHtml = '';
                            if (secondaryField && item[secondaryField]) {
                                secondaryHtml = '<div class="text-muted small">' + self.escapeHtml(item[secondaryField]) + '</div>';
                            }
                            
                            let typeHtml = '';
                            if (item.type) {
                                typeHtml = '<span class="badge bg-secondary">' + self.escapeHtml(item.type) + '</span>';
                            }
                            
                            itemElement.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">${self.escapeHtml(item[displayField])}</div>
                                        ${secondaryHtml}
                                    </div>
                                    ${typeHtml}
                                </div>
                            `;
                            
                            itemElement.addEventListener('click', function() { 
                                self.onItemSelect(item); 
                            });
                            
                            self.elements.list.appendChild(itemElement);
                        });
                    }

                    onItemSelect(item) {
                        this.state.selectedItem = item;
                        this.state.searchTerm = item[this.config.displayField || 'name'];
                        this.elements.input.value = this.state.searchTerm;
                        this.elements.hiddenInput.value = item.id;
                        this.elements.clearBtn.style.display = 'block';
                        this.hideSuggestions();

                        // Call custom callback if provided
                        if (this.config.onSelect) {
                            this.config.onSelect(item);
                        }
                    }

                    clearSearch() {
                        this.state.searchTerm = "";
                        this.state.selectedItem = null;
                        this.state.filteredItems = [];
                        this.elements.input.value = "";
                        this.elements.hiddenInput.value = "";
                        this.elements.clearBtn.style.display = 'none';
                        this.hideSuggestions();
                        
                        // Focus back on input
                        this.elements.input.focus();

                        // Call custom callback if provided
                        if (this.config.onClear) {
                            this.config.onClear();
                        }
                    }

                    showSuggestions() {
                        this.elements.suggestions.style.display = 'block';
                    }

                    hideSuggestions() {
                        this.elements.suggestions.style.display = 'none';
                    }

                    focusNextItem() {
                        const items = this.elements.list.querySelectorAll('.list-group-item');
                        if (items.length === 0) return;
                        
                        const activeItem = this.elements.list.querySelector('.list-group-item:focus');
                        if (!activeItem) {
                            items[0].focus();
                        } else {
                            const currentIndex = parseInt(activeItem.getAttribute('data-index'));
                            if (currentIndex < items.length - 1) {
                                items[currentIndex + 1].focus();
                            }
                        }
                    }

                    focusPreviousItem() {
                        const items = this.elements.list.querySelectorAll('.list-group-item');
                        if (items.length === 0) return;
                        
                        const activeItem = this.elements.list.querySelector('.list-group-item:focus');
                        if (activeItem) {
                            const currentIndex = parseInt(activeItem.getAttribute('data-index'));
                            if (currentIndex > 0) {
                                items[currentIndex - 1].focus();
                            }
                        }
                    }

                    escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }

                    // Public methods
                    setValue(value) {
                        if (value && value.id) {
                            this.onItemSelect(value);
                        }
                    }

                    getValue() {
                        return this.state.selectedItem;
                    }

                    clear() {
                        this.clearSearch();
                    }
                }

                // Global variables
                let customerSearch;
                let categorySearches = {};
                let productSearches = {};
                let orderLineCount = 0;
                let currentPricelistId = null;
                let currentCurrencySymbol = '$';

                // Function to update pricelist display
                function updatePricelistDisplay(customerData) {
                    const pricelistDisplay = document.getElementById('pricelist-display');
                    const pricelistIdInput = document.getElementById('pricelist-id');
                    const currencySymbol = document.getElementById('currency-symbol');
                    
                    if (customerData && customerData.pricelist_name) {
                        pricelistDisplay.value = customerData.pricelist_name;
                        currentPricelistId = customerData.pricelist_id;
                        pricelistIdInput.value = currentPricelistId;
                        
                        // Update currency symbol
                        if (customerData.pricelist_id) {
                            // Fetch detailed pricelist info
                            fetchPricelistDetails(customerData.pricelist_id);
                        }
                    } else {
                        pricelistDisplay.value = '';
                        currentPricelistId = null;
                        pricelistIdInput.value = '';
                        currencySymbol.textContent = '';
                    }
                }

                // Function to fetch pricelist details
                async function fetchPricelistDetails(pricelistId) {
                    try {
                        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                        
                        const response = await fetch('/sales_management/quotation/get-customer-pricelist', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify({
                                jsonrpc: "2.0",
                                method: "call",
                                params: {
                                    customer_id: customerSearch.getValue().id
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.result) {
                            const pricelistInfo = data.result;
                            const currencySymbol = document.getElementById('currency-symbol');
                            if (pricelistInfo.currency_symbol) {
                                currencySymbol.textContent = pricelistInfo.currency_symbol;
                                currentCurrencySymbol = pricelistInfo.currency_symbol;
                            }
                        }
                        
                    } catch (error) {
                        console.error('Error fetching pricelist details:', error);
                    }
                }

                // Function to get product price from pricelist
                async function getProductPriceFromPricelist(productId, lineElement) {
                    if (!currentPricelistId || !productId) {
                        return null;
                    }
                    
                    try {
                        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                        const quantityInput = lineElement.querySelector('.quantity-input');
                        const quantity = quantityInput ? parseFloat(quantityInput.value) || 1 : 1;
                        
                        const response = await fetch('/sales_management/quotation/get-product-price-pricelist', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify({
                                jsonrpc: "2.0",
                                method: "call",
                                params: {
                                    product_id: productId,
                                    pricelist_id: currentPricelistId,
                                    quantity: quantity
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.result && data.result.price) {
                            return data.result;
                        } else if (data.price) {
                            return data;
                        }
                        
                        return null;
                        
                    } catch (error) {
                        console.error('Error getting product price from pricelist:', error);
                        return null;
                    }
                }

                // Function to update all product prices when pricelist changes
                async function updateAllProductPrices() {
                    if (!currentPricelistId) return;
                    
                    const orderLines = document.querySelectorAll('.order-line-item');
                    
                    for (const line of orderLines) {
                        const productHiddenInput = line.querySelector('input[name="product_id[]"]');
                        const priceInput = line.querySelector('.price-input');
                        const amountDisplay = line.querySelector('.amount-display');
                        const quantityInput = line.querySelector('.quantity-input');
                        
                        if (productHiddenInput && productHiddenInput.value) {
                            const productId = productHiddenInput.value;
                            const priceData = await getProductPriceFromPricelist(productId, line);
                            
                            if (priceData) {
                                priceInput.value = parseFloat(priceData.price || 0).toFixed(2);
                                
                                if (priceData.currency_symbol) {
                                    currentCurrencySymbol = priceData.currency_symbol;
                                }
                                
                                // Update currency symbol in displays
                                const currencySymbols = document.querySelectorAll('#currency-symbol');
                                currencySymbols.forEach(symbol => {
                                    symbol.textContent = currentCurrencySymbol;
                                });
                                
                                // Update amount display
                                const quantity = parseFloat(quantityInput.value) || 0;
                                const total = (priceData.price || 0) * quantity;
                                amountDisplay.value = currentCurrencySymbol + total.toFixed(2);
                                
                                // Show/hide discount info
                                updateDiscountInfo(priceInput, priceData);
                            }
                        }
                    }
                    
                    calculateTotalAmount();
                }

                // Function to update discount info display
                function updateDiscountInfo(priceInput, priceData) {
                    // Remove existing discount info
                    const existingDiscount = priceInput.parentNode.querySelector('.discount-info');
                    if (existingDiscount) {
                        existingDiscount.remove();
                    }
                    
                    // Add new discount info if applicable
                    if (priceData.has_discount) {
                        const discountInfo = document.createElement('small');
                        discountInfo.className = 'discount-info text-success d-block mt-1';
                        discountInfo.innerHTML = `<i class="fa fa-tag me-1"></i>${priceData.discount_percentage.toFixed(1)}% discount applied`;
                        priceInput.parentNode.appendChild(discountInfo);
                    }
                }

                // Add order line
                function addOrderLine() {
                    const container = document.getElementById('order-lines-container');
                    const lineId = 'order-line-' + orderLineCount;
                    
                    const newLine = document.createElement('div');
                    newLine.className = 'order-line-item mb-4 border-bottom pb-4';
                    newLine.id = lineId;
                    
                    // Create category and product search containers for this line
                    const categorySearchContainerId = 'category-search-' + orderLineCount;
                    const productSearchContainerId = 'product-search-' + orderLineCount;
                    
                    newLine.innerHTML = 
                        '<div class="d-flex justify-content-between align-items-center mb-3">' +
                            '<h6 class="mb-0">Product Line ' + (orderLineCount + 1) + '</h6>' +
                            '<button type="button" class="btn btn-danger btn-sm remove-btn" onclick="removeOrderLine(\'' + lineId + '\')">' +
                                '<i class="fa fa-trash me-1"></i>Remove' +
                            '</button>' +
                        '</div>' +
                        '<div class="row">' +
                            '<div class="col-md-3 mb-3">' +
                                '<label class="form-label">Category</label>' +
                                '<div id="' + categorySearchContainerId + '"></div>' +
                                '<small class="text-muted">Select to filter products</small>' +
                            '</div>' +
                            '<div class="col-md-3 mb-3">' +
                                '<label class="form-label">Product *</label>' +
                                '<div id="' + productSearchContainerId + '"></div>' +
                                '<small class="text-muted">Filtered by selected category</small>' +
                            '</div>' +
                            '<div class="col-md-2 mb-3">' +
                                '<label class="form-label">Quantity *</label>' +
                                '<input type="number" class="form-control quantity-input" name="quantity[]" value="1" min="1" step="1" required="required" onchange="calculateLineTotal(this)"/>' +
                            '</div>' +
                            '<div class="col-md-2 mb-3">' +
                                '<label class="form-label">Unit Price</label>' +
                                '<input type="number" class="form-control price-input" name="price_unit[]" readonly="readonly" step="0.01"/>' +
                            '</div>' +
                            '<div class="col-md-2 mb-3">' +
                                '<label class="form-label">Amount</label>' +
                                '<input type="text" class="form-control amount-display" readonly="readonly" value="' + currentCurrencySymbol + '0.00"/>' +
                            '</div>' +
                        '</div>';
                    
                    container.appendChild(newLine);
                    
                    // Initialize category search for this line
                    const categorySearch = new SearchDropdown({
                        container: document.getElementById(categorySearchContainerId),
                        placeholder: 'Search for category...',
                        name: 'category_id[]',
                        searchUrl: '/sales_management/search/categories',
                        displayField: 'name',
                        onSelect: function(category) {
                            const lineDiv = document.getElementById(categorySearchContainerId).closest('.order-line-item');
                            const productSearchContainerId = lineDiv.querySelector('div[id^="product-search-"]').id;
                            const productSearch = productSearches[productSearchContainerId];
                            
                            if (productSearch) {
                                // Clear current product selection
                                productSearch.clear();
                                
                                // Update product search to filter by this category
                                productSearch.config.searchUrl = '/sales_management/search/products_by_category';
                                productSearch.config.searchUrl = '/sales_management/search/products_by_category?category_id=' + category.id;
                                
                                // Show placeholder text about filtering
                                const productInput = document.getElementById(productSearchContainerId).querySelector('.search-dropdown-input');
                                if (productInput) {
                                    productInput.placeholder = 'Products in: ' + category.name;
                                }
                            }
                        },
                        onClear: function() {
                            const lineDiv = document.getElementById(categorySearchContainerId).closest('.order-line-item');
                            const productSearchContainerId = lineDiv.querySelector('div[id^="product-search-"]').id;
                            const productSearch = productSearches[productSearchContainerId];
                            
                            if (productSearch) {
                                // Reset product search to show all products
                                productSearch.clear();
                                productSearch.config.searchUrl = '/sales_management/search/products';
                                
                                // Reset placeholder
                                const productInput = document.getElementById(productSearchContainerId).querySelector('.search-dropdown-input');
                                if (productInput) {
                                    productInput.placeholder = 'Search for product...';
                                }
                            }
                        }
                    });
                    
                    // Initialize product search for this line
                    const productSearch = new SearchDropdown({
                        container: document.getElementById(productSearchContainerId),
                        placeholder: 'Search for product...',
                        name: 'product_id[]',
                        searchUrl: '/sales_management/search/products',
                        displayField: 'name',
                        onSelect: async function(product) {
                            const row = document.getElementById(productSearchContainerId).closest('.row');
                            const priceInput = row.querySelector('.price-input');
                            const quantityInput = row.querySelector('.quantity-input');
                            const lineElement = row.closest('.order-line-item');
                            
                            // Get price from pricelist if available
                            if (currentPricelistId) {
                                const priceData = await getProductPriceFromPricelist(product.id, lineElement);
                                
                                if (priceData) {
                                    priceInput.value = parseFloat(priceData.price || 0).toFixed(2);
                                    
                                    if (priceData.currency_symbol) {
                                        currentCurrencySymbol = priceData.currency_symbol;
                                    }
                                    
                                    // Update discount info
                                    updateDiscountInfo(priceInput, priceData);
                                } else {
                                    // Fallback to list price
                                    priceInput.value = parseFloat(product.list_price || 0).toFixed(2);
                                }
                            } else {
                                // Use list price if no pricelist
                                priceInput.value = parseFloat(product.list_price || 0).toFixed(2);
                            }
                            
                            calculateLineTotal(quantityInput);
                            
                            // If category is not set, auto-fill it from product
                            const categorySearchContainerId = 'category-search-' + productSearchContainerId.split('-')[2];
                            const categorySearch = categorySearches[categorySearchContainerId];
                            
                            if (categorySearch && !categorySearch.getValue() && product.category_id) {
                                // Auto-fill category from product
                                categorySearch.setValue({
                                    id: product.category_id,
                                    name: product.category_name || 'Unknown Category'
                                });
                            }
                            
                            console.log('Product selected:', product);
                        },
                        onClear: function() {
                            const row = document.getElementById(productSearchContainerId).closest('.row');
                            const priceInput = row.querySelector('.price-input');
                            
                            // Clear price and any discount info
                            priceInput.value = '';
                            const discountInfo = priceInput.parentNode.querySelector('.discount-info');
                            if (discountInfo) {
                                discountInfo.remove();
                            }
                            
                            console.log('Product search cleared');
                        }
                    });
                    
                    // Store references to searches
                    categorySearches[categorySearchContainerId] = categorySearch;
                    productSearches[productSearchContainerId] = productSearch;
                    
                    orderLineCount++;
                    calculateTotalAmount();
                }

                // Remove order line
                function removeOrderLine(lineId) {
                    const lineElement = document.getElementById(lineId);
                    if (lineElement) {
                        // Remove search references
                        const lineNumber = lineId.split('-')[2];
                        const categorySearchContainerId = 'category-search-' + lineNumber;
                        const productSearchContainerId = 'product-search-' + lineNumber;
                        
                        delete categorySearches[categorySearchContainerId];
                        delete productSearches[productSearchContainerId];
                        
                        lineElement.remove();
                        calculateTotalAmount();
                    }
                }

                // Calculate line total
                function calculateLineTotal(inputElement) {
                    const row = inputElement.closest('.row');
                    const priceInput = row.querySelector('.price-input');
                    const quantityInput = row.querySelector('.quantity-input');
                    const amountDisplay = row.querySelector('.amount-display');
                    
                    const price = parseFloat(priceInput.value) || 0;
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const total = price * quantity;
                    
                    amountDisplay.value = currentCurrencySymbol + total.toFixed(2);
                    calculateTotalAmount();
                }

                // Calculate total amount
                function calculateTotalAmount() {
                    const amountDisplays = document.querySelectorAll('.amount-display');
                    let total = 0;
                    
                    amountDisplays.forEach(function(display) {
                        const value = display.value.replace(currentCurrencySymbol, '');
                        total += parseFloat(value) || 0;
                    });
                    
                    document.getElementById('total-amount').textContent = currentCurrencySymbol + total.toFixed(2);
                }

                // Initialize on DOM ready
                document.addEventListener("DOMContentLoaded", function () {
                    console.log('Quotation form loaded - initializing search dropdowns');
                
                    // Initialize Customer Search Dropdown
                    const customerContainer = document.getElementById('customer-search-container');
                    if (customerContainer) {
                        customerSearch = new SearchDropdown({
                            container: customerContainer,
                            placeholder: 'Search for customer...',
                            name: 'partner_id',
                            searchUrl: '/sales_management/search/customers',
                            displayField: 'name',
                            secondaryField: 'phone',
                            onSelect: function(customer) {
                                console.log('Customer selected:', customer);
                                updatePricelistDisplay(customer);
                                
                                // Update all existing product prices based on new pricelist
                                updateAllProductPrices();
                            },
                            onClear: function() {
                                console.log('Customer cleared');
                                updatePricelistDisplay(null);
                            }
                        });
                    }

                    // Add first order line by default
                    addOrderLine();

                    // Initialize sidebar menu active state
                    const menuItems = document.querySelectorAll("#sidebarMenu a");
                    const currentPath = window.location.pathname;
                    menuItems.forEach(function(item) {
                        item.classList.remove("active");
                        if (item.getAttribute("href") === currentPath) {
                            item.classList.add("active");
                        }
                    });
                });

                // Form validation
                document.getElementById('quotationForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Validate customer selection
                    const customer = customerSearch ? customerSearch.getValue() : null;
                    if (!customer) {
                        alert('Please select a customer.');
                        if (customerSearch && customerSearch.elements.input) {
                            customerSearch.elements.input.focus();
                        }
                        return;
                    }
                    
                    // Validate pricelist
                    if (!currentPricelistId) {
                        alert('No pricelist found for the selected customer. Please contact administrator.');
                        return;
                    }
                    
                    // Validate at least one product is selected
                    const productInputs = document.querySelectorAll('input[name="product_id[]"]');
                    let hasProducts = false;
                    
                    productInputs.forEach(function(input) {
                        if (input.value && input.value.trim() !== '') {
                            hasProducts = true;
                        }
                    });
                    
                    if (!hasProducts) {
                        alert('Please add at least one product to the quotation.');
                        return;
                    }
                    
                    // Validate each product has a quantity
                    const quantityInputs = document.querySelectorAll('input[name="quantity[]"]');
                    let allValid = true;
                    
                    quantityInputs.forEach(function(input) {
                        if (!input.value || parseFloat(input.value) <= 0) {
                            allValid = false;
                            input.classList.add('is-invalid');
                        } else {
                            input.classList.remove('is-invalid');
                        }
                    });
                    
                    if (!allValid) {
                        alert('Please enter valid quantities for all products.');
                        return;
                    }
                    
                    // Show loading state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Creating...';
                    submitBtn.disabled = true;
                    
                    // Collect all form data including product prices
                    const formData = new FormData(this);
                    
                    // Add pricelist_id to form data
                    if (currentPricelistId) {
                        formData.append('pricelist_id', currentPricelistId);
                    }
                    
                    // Add price_unit values for each product line
                    const priceInputs = document.querySelectorAll('input[name="price_unit[]"]');
                    priceInputs.forEach((input, index) => {
                        formData.append('price_unit[]', input.value || '0');
                    });
                    
                    // Debug: Show what's being submitted
                    console.log('Submitting form data:');
                    for (let pair of formData.entries()) {
                        console.log(pair[0] + ': ' + pair[1]);
                    }
                    
                    // Submit the form via fetch
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('input[name="csrf_token"]').value
                        }
                    })
                    .then(response => {
                        if (response.redirected) {
                            // If redirected to success page
                            window.location.href = response.url;
                        } else if (response.ok) {
                            return response.text().then(html => {
                                // Check if there's an error in the response
                                if (html.includes('error')) {
                                    throw new Error('Form submission error');
                                }
                                // Otherwise redirect to success
                                window.location.href = '/sales_management/quotation?success=1';
                            });
                        } else {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('There was an error creating the quotation. Please try again.');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
                });
            ]]>
            </script>
        </t>
    </template>

    <template id="quotation_view" name="Quotation View Details">
        <div class="quotation-view-content">
            <t t-if="quotation">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="section-header">Quotation Information</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Order Number</label>
                            <p class="form-control-plaintext" t-esc="quotation.name"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Customer</label>
                            <p class="form-control-plaintext" t-esc="quotation.partner_id.complete_name"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Date</label>
                            <p class="form-control-plaintext" t-esc="quotation.date_order"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Status</label>
                            <p class="form-control-plaintext">
                                <span class="quote-status" t-att-class="'status-' + quotation.state">
                                    <t t-if="quotation.state == 'draft'">Quotation</t>
                                    <t t-elif="quotation.state == 'sent'">Quotation Sent</t>
                                    <t t-elif="quotation.state == 'sale'">Sales Order</t>
                                    <t t-elif="quotation.state == 'cancel'">Cancelled</t>
                                    <t t-else=""><t t-esc="quotation.state.title()"/></t>
                                </span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="section-header">Amount Information</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Subtotal</label>
                            <p class="form-control-plaintext" t-esc="'${:,.2f}'.format(quotation.amount_untaxed)"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tax</label>
                            <p class="form-control-plaintext" t-esc="'${:,.2f}'.format(quotation.amount_tax)"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Total Amount</label>
                            <p class="form-control-plaintext fs-5 fw-bold text-primary">
                                <t t-esc="'${:,.2f}'.format(quotation.amount_total)"/>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="section-header">Order Lines</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Tax</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="quotation.order_line" t-as="line">
                                        <tr>
                                            <td t-esc="line.product_id.name"/>
                                            <td t-esc="line.product_uom_qty"/>
                                            <td t-esc="'${:,.2f}'.format(line.price_unit)"/>
                                            <td t-esc="'${:,.2f}'.format(line.price_tax)"/>
                                            <td t-esc="'${:,.2f}'.format(line.price_subtotal)"/>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </t>
            <t t-else="">
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    Quotation not found or you don't have permission to view this quotation.
                </div>
            </t>
        </div>
    </template>

</odoo>