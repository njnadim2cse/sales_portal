<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="contacts_list" name="Contacts List">
        <t t-call="website.layout">
            <t t-set="head">
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
                <style>
                    /* Enhanced Sidebar Design */
                    .dashboard-sidebar {
                        position: fixed;
                        top: 70px;
                        left: 0;
                        height: calc(100vh - 70px);
                        width: 280px;
                        background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
                        border-right: none;
                        box-shadow: 4px 0 20px rgba(0,0,0,0.1);
                        z-index: 1000;
                        padding-top: 20px;
                        overflow-y: auto;
                        transition: all 0.3s ease;
                    }

                    .dashboard-sidebar .sidebar-header {
                        padding: 0 25px 20px;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                        margin-bottom: 15px;
                    }

                    .dashboard-sidebar .sidebar-header h4 {
                        color: white;
                        font-weight: 600;
                        margin: 0;
                        font-size: 1.2rem;
                    }

                    .dashboard-sidebar .list-group-item {
                        border: none;
                        border-radius: 12px;
                        padding: 16px 20px;
                        margin: 4px 15px;
                        font-weight: 500;
                        color: rgba(255,255,255,0.9);
                        background: transparent;
                        transition: all 0.3s ease;
                        border-left: 3px solid transparent;
                    }

                    .dashboard-sidebar .list-group-item:hover {
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border-left-color: #e74c3c;
                        transform: translateX(5px);
                    }

                    .dashboard-sidebar .list-group-item.active {
                        background: rgba(255,255,255,0.15);
                        color: white;
                        border-left-color: #e74c3c;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }

                    .dashboard-sidebar .list-group-item i {
                        width: 20px;
                        text-align: center;
                        margin-right: 12px;
                        font-size: 1.1rem;
                    }

                    .dashboard-content {
                        margin-left: 300px;
                        padding: 30px;
                        min-height: calc(100vh - 70px);
                        background: #f8fafc;
                    }

                    /* Enhanced Card Design */
                    .card {
                        border: none;
                        border-radius: 16px;
                        box-shadow: 0 4px 25px rgba(0,0,0,0.08);
                        margin-bottom: 25px;
                        overflow: hidden;
                    }

                    .card-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 20px 25px;
                    }

                    .card-header h2 {
                        margin: 0;
                        font-weight: 600;
                        font-size: 1.5rem;
                    }

                    /* Enhanced Table Design */
                    .table-responsive {
                        border-radius: 12px;
                        overflow: hidden;
                    }

                    .table {
                        margin: 0;
                    }

                    .table thead th {
                        background: #2c3e50;
                        color: white;
                        border: none;
                        padding: 16px 12px;
                        font-weight: 600;
                        font-size: 0.9rem;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .table tbody td {
                        padding: 16px 12px;
                        vertical-align: middle;
                        border-color: #f1f3f4;
                    }

                    .table tbody tr {
                        transition: all 0.3s ease;
                    }

                    .table tbody tr:hover {
                        background: #f8f9fa;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    }

                    /* Enhanced Badges */
                    .badge {
                        padding: 8px 12px;
                        border-radius: 20px;
                        font-weight: 500;
                        font-size: 0.75rem;
                    }

                    .bg-primary {
                        background: linear-gradient(45deg, #3498db, #2980b9) !important;
                    }

                    .bg-success {
                        background: linear-gradient(45deg, #27ae60, #2ecc71) !important;
                    }

                    .bg-secondary {
                        background: linear-gradient(45deg, #95a5a6, #7f8c8d) !important;
                    }

                    /* Enhanced Buttons */
                    .btn-primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        border-radius: 10px;
                        padding: 12px 24px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    }

                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                    }

                    /* Contact Person Widget */
                    .contact-person-widget {
                        border: 1px solid #e9ecef;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        background: white;
                        position: relative;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                        transition: all 0.3s ease;
                    }

                    .contact-person-widget:hover {
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                    }

                    .contact-person-widget .remove-btn {
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        border-radius: 8px;
                    }

                    /* Wizard Modal */
                    .contact-wizard {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1050;
                    }

                    .wizard-content {
                        background: white;
                        border-radius: 16px;
                        padding: 30px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }

                    /* Form Enhancements */
                    .form-control {
                        border-radius: 10px;
                        border: 2px solid #e9ecef;
                        padding: 12px 16px;
                        transition: all 0.3s ease;
                    }

                    .form-control:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                    }

                    .form-label {
                        font-weight: 600;
                        color: #2c3e50;
                        margin-bottom: 8px;
                    }

                    /* Section Headers */
                    .section-header {
                        color: #2c3e50;
                        font-weight: 600;
                        margin-bottom: 20px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #3498db;
                    }
                    .contact-person-card {
                        border: 1px solid #e9ecef;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 15px;
                        background: white;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                        cursor: pointer;
                    }
                    .contact-person-card:hover {
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        transform: translateY(-2px);
                        border-color: #3498db;
                    }
                    .form-control-plaintext {
                        padding: 8px 0;
                        border: none;
                        background: transparent;
                        min-height: auto;
                    }
                    .contact-view-content .section-header,
                    .contact-person-view-content .section-header {
                        color: #2c3e50;
                        font-weight: 600;
                        margin-bottom: 20px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #3498db;
                    }
                    .form-label.fw-bold {
                        color: #2c3e50;
                        margin-bottom: 8px;
                    }

                    /* Search Dropdown Styles */
                    .search-dropdown-container {
                        position: relative;
                    }

                    .search-suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        max-height: 300px;
                        overflow-y: auto;
                        z-index: 1060;
                        border: 1px solid #dee2e6;
                        border-radius: 0.375rem;
                        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                        display: none;
                        margin-top: 2px;
                    }

                    .search-suggestions .list-group-item {
                        border: none;
                        border-bottom: 1px solid #f8f9fa;
                        padding: 12px 16px;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }

                    .search-suggestions .list-group-item:hover,
                    .search-suggestions .list-group-item:focus {
                        background-color: #f8f9fa;
                        outline: none;
                    }

                    .search-suggestions .list-group-item:last-child {
                        border-bottom: none;
                    }

                    .search-dropdown-input {
                        border-radius: 0.375rem 0 0 0.375rem !important;
                    }

                    .clear-search-btn {
                        border-radius: 0 0.375rem 0.375rem 0 !important;
                        z-index: 10;
                    }

                    .badge {
                        font-size: 0.75rem;
                        padding: 0.25rem 0.5rem;
                    }

                    @media (max-width: 1024px) {
                        .dashboard-sidebar {
                            width: 250px;
                        }
                        .dashboard-content {
                            margin-left: 270px;
                        }
                    }

                    @media (max-width: 768px) {
                        .dashboard-sidebar {
                            width: 100%;
                            height: auto;
                            position: relative;
                            top: 0;
                        }
                        
                        .dashboard-content {
                            margin-left: 0;
                            padding: 20px 15px;
                        }
                    }
                </style>
            </t>
            
            <div class="container-fluid">
                <div class="row">
                    <!-- Enhanced Sidebar -->
                    <div class="dashboard-sidebar">
                        <div class="sidebar-header">
                            <h4>Sales Management</h4>
                        </div>
                        <div class="list-group" id="sidebarMenu">
                            <!-- Dashboard - Always visible -->
                            <a href="/sales_management" class="list-group-item list-group-item-action">
                                <i class="fa fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                            
                            <!-- Sales Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_sales_portal">
                                <a href="/sales_management/sales" class="list-group-item list-group-item-action">
                                    <i class="fa fa-briefcase me-2"></i> Sales
                                </a>
                            </t>
                            <!-- Service Portal - Conditionally visible -->
                             <t t-if="request.env.user.use_service_portal">
                                <a href="/sales_management/service" class="list-group-item list-group-item-action">
                                    <i class="fa fa-concierge-bell me-2"></i> Service
                                </a>
                            </t>
                            
                            <!-- Contacts Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_contact_portal">
                                <a href="/sales_management/contacts" class="list-group-item list-group-item-action active">
                                    <i class="fa fa-users me-2"></i> Contacts
                                </a>
                            </t>
                            
                            <!-- Quotation Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_quotation_portal">
                                <a href="/sales_management/quotation" class="list-group-item list-group-item-action">
                                    <i class="fa fa-file-invoice-dollar me-2"></i> Quotation
                                </a>
                            </t>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="dashboard-content col">
                        <!-- Search Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <form method="get" action="/sales_management/contacts" class="row g-3 align-items-center">
                                    <div class="col-md-8">
                                        <input type="text" name="search" class="form-control" placeholder="Search by name, email, phone, city, state, country..." 
                                            t-att-value="search_term or ''"/>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fa fa-search me-2"></i>Search
                                        </button>
                                    </div>
                                    <div class="col-md-2">
                                        <a href="/sales_management/contacts" class="btn btn-outline-secondary w-100">
                                            <i class="fa fa-refresh me-2"></i>Clear
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 class="mb-1">Contacts</h2>
                                <p class="text-muted mb-0">Manage your contacts and companies</p>
                            </div>
                            <a href="/sales_management/contacts/create" class="btn btn-primary">
                                <i class="fa fa-plus me-2"></i>Create Contact
                            </a>
                        </div>

                        <!-- Contacts Table -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="mb-0">All Contacts</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Tags</th>
                                                <th>Country</th>
                                                <th>Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="contacts" t-as="contact">
                                                <tr>
                                                    <td>
                                                        <strong t-esc="contact.complete_name or contact.name"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="contact.email">
                                                            <a t-att-href="'mailto:' + contact.email" t-esc="contact.email"/>
                                                        </t>
                                                        <t t-else="">-</t>
                                                    </td>
                                                    <td>
                                                        <t t-if="contact.phone">
                                                            <a t-att-href="'tel:' + contact.phone" t-esc="contact.phone"/>
                                                        </t>
                                                        <t t-else="">-</t>
                                                    </td>
                                                    <td>
                                                        <t t-foreach="contact.category_id" t-as="tag">
                                                            <span class="badge bg-secondary me-1 mb-1" t-esc="tag.name"/>
                                                        </t>
                                                        <t t-if="not contact.category_id">-</t>
                                                    </td>
                                                    <td>
                                                        <t t-esc="contact.country_id.name if contact.country_id else '-'"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge" t-att-class="'bg-primary' if contact.is_company else 'bg-success'">
                                                            <t t-esc="'Company' if contact.is_company else 'Person'"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <button type="button" class="btn btn-sm btn-outline-primary view-contact-btn" 
                                                                    t-att-data-contact-id="contact.id" title="View">
                                                                <i class="fa fa-eye"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </t>
                                            <t t-if="not contacts">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted py-5">
                                                        <i class="fa fa-users fa-3x mb-3 text-muted"></i>
                                                        <p class="mb-2">No contacts found</p>
                                                        <a href="/sales_management/contacts/create" class="btn btn-primary">
                                                            Create your first contact
                                                        </a>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact View Modal -->
            <div class="modal fade" id="contactViewModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Contact Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="contactViewContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Person View Modal -->
            <div class="modal fade" id="contactPersonViewModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-md">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Contact Person Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="contactPersonViewContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
                // SIMPLE Search Dropdown Component
                class SimpleSearchDropdown {
                    constructor(config) {
                        this.config = config;
                        this.selectedItem = null;
                        this.input = null;
                        this.hiddenInput = null;
                        this.suggestions = null;
                        this.list = null;
                        this.init();
                    }

                    init() {
                        this.createHTML();
                        this.bindEvents();
                    }

                    createHTML() {
                        const container = this.config.container;
                        const placeholder = this.config.placeholder;
                        const name = this.config.name;
                        
                        const html = '&lt;div class="search-dropdown-container position-relative"&gt;' +
                                    '&lt;div class="input-group"&gt;' +
                                        '&lt;input type="text" ' +
                                            'class="form-control search-dropdown-input" ' +
                                            'placeholder="' + placeholder + '" ' +
                                            'autocomplete="off"&gt;' +
                                        '&lt;input type="hidden" name="' + name + '" class="selected-value"&gt;' +
                                        '&lt;button class="btn btn-outline-secondary clear-search-btn" type="button" style="display: none;"&gt;' +
                                            '&lt;i class="fa fa-times"&gt;&lt;/i&gt;' +
                                        '&lt;/button&gt;' +
                                    '&lt;/div&gt;' +
                                    '&lt;div class="search-suggestions dropdown-menu w-100" style="display: none;"&gt;' +
                                        '&lt;div class="list-group"&gt;&lt;/div&gt;' +
                                    '&lt;/div&gt;' +
                                '&lt;/div&gt;';
                        
                        container.innerHTML = html;
                        
                        this.input = container.querySelector('.search-dropdown-input');
                        this.hiddenInput = container.querySelector('.selected-value');
                        this.suggestions = container.querySelector('.search-suggestions');
                        this.list = container.querySelector('.list-group');
                        this.clearBtn = container.querySelector('.clear-search-btn');
                    }

                    bindEvents() {
                        const self = this;
                        
                        // Input events
                        this.input.addEventListener('input', function(ev) { 
                            self.onSearchChange(ev); 
                        });
                        
                        this.input.addEventListener('focus', function() { 
                            if (!self.input.value) {
                                self.searchItems('');
                            }
                        });
                        
                        this.input.addEventListener('blur', function() { 
                            setTimeout(function() {
                                self.hideSuggestions();
                            }, 200);
                        });
                        
                        this.clearBtn.addEventListener('click', function() { 
                            self.clearSearch(); 
                        });
                        
                        // Prevent form submission on enter
                        this.input.addEventListener('keydown', function(ev) {
                            if (ev.key === 'Enter') {
                                ev.preventDefault();
                            }
                        });
                    }

                    async searchItems(searchTerm) {
                        try {
                            console.log('Searching for:', searchTerm);
                            
                            const response = await fetch(this.config.searchUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': this.getCSRFToken()
                                },
                                body: JSON.stringify({
                                    search_term: searchTerm
                                })
                            });
                            
                            const data = await response.json();
                            console.log('Search response:', data);
                            
                            this.renderSuggestions(data.items || []);
                            this.showSuggestions();
                            
                        } catch (error) {
                            console.error('Error searching items:', error);
                            this.renderSuggestions([]);
                            this.showSuggestions();
                        }
                    }

                    onSearchChange(ev) {
                        const searchTerm = ev.target.value;
                        
                        // Show/hide clear button
                        this.clearBtn.style.display = searchTerm ? 'block' : 'none';
                        
                        this.searchItems(searchTerm);
                    }

                    renderSuggestions(items) {
                        const displayField = this.config.displayField || 'name';
                        const secondaryField = this.config.secondaryField;
                        this.list.innerHTML = '';

                        if (items.length === 0) {
                            this.list.innerHTML = '&lt;div class="list-group-item text-muted text-center"&gt;No results found&lt;/div&gt;';
                            return;
                        }

                        const self = this;
                        items.forEach(function(item) {
                            const itemElement = document.createElement('button');
                            itemElement.type = 'button';
                            itemElement.className = 'list-group-item list-group-item-action';
                            
                            let secondaryHtml = '';
                            if (secondaryField &amp;&amp; item[secondaryField]) {
                                secondaryHtml = '&lt;div class="text-muted small"&gt;' + item[secondaryField] + '&lt;/div&gt;';
                            }
                            
                            itemElement.innerHTML = '&lt;div class="d-flex justify-content-between align-items-center"&gt;' +
                                        '&lt;div&gt;' +
                                            '&lt;div class="fw-bold"&gt;' + item[displayField] + '&lt;/div&gt;' +
                                            secondaryHtml +
                                        '&lt;/div&gt;' +
                                        '&lt;div class="text-muted small"&gt;' + (item.type || '') + '&lt;/div&gt;' +
                                    '&lt;/div&gt;';
                            
                            itemElement.addEventListener('click', function() { 
                                self.onItemSelect(item); 
                            });
                            
                            self.list.appendChild(itemElement);
                        });
                    }

                    onItemSelect(item) {
                        this.selectedItem = item;
                        const displayField = this.config.displayField || 'name';
                        this.input.value = item[displayField];
                        this.hiddenInput.value = item.id;
                        this.hideSuggestions();

                        console.log('Selected item:', item);

                        // Call custom callback if provided
                        if (this.config.onSelect) {
                            this.config.onSelect(item);
                        }
                    }

                    clearSearch() {
                        this.selectedItem = null;
                        this.input.value = "";
                        this.hiddenInput.value = "";
                        this.clearBtn.style.display = 'none';
                        this.hideSuggestions();

                        // Call custom callback if provided
                        if (this.config.onClear) {
                            this.config.onClear();
                        }
                    }

                    showSuggestions() {
                        this.suggestions.style.display = 'block';
                    }

                    hideSuggestions() {
                        this.suggestions.style.display = 'none';
                    }

                    getCSRFToken() {
                        const csrfToken = document.querySelector('input[name="csrf_token"]');
                        return csrfToken ? csrfToken.value : '';
                    }

                    // Public methods
                    getValue() {
                        return this.selectedItem;
                    }

                    clear() {
                        this.clearSearch();
                    }
                }

                document.addEventListener("DOMContentLoaded", function () {
                    const menuItems = document.querySelectorAll("#sidebarMenu a");
                    const currentPath = window.location.pathname;

                    menuItems.forEach(function(item) {
                        item.classList.remove("active");
                        if (item.getAttribute("href") === currentPath) {
                            item.classList.add("active");
                        }
                    });

                    // Add event listeners for view buttons
                    document.querySelectorAll('.view-contact-btn').forEach(function(button) {
                        button.addEventListener('click', function() {
                            const contactId = this.getAttribute('data-contact-id');
                            viewContact(contactId);
                        });
                    });
                });

                function viewContact(contactId) {
                    // Show loading state
                    document.getElementById('contactViewContent').innerHTML = '&lt;div class="text-center p-4"&gt;&lt;div class="spinner-border" role="status"&gt;&lt;/div&gt;&lt;p class="mt-2"&gt;Loading contact details...&lt;/p&gt;&lt;/div&gt;';
                    
                    // Check if bootstrap is available
                    if (typeof bootstrap !== 'undefined') {
                        const modalElement = document.getElementById('contactViewModal');
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        // Fallback: show the modal directly
                        document.getElementById('contactViewModal').style.display = 'block';
                    }
                    
                    // Then load content
                    fetch('/sales_management/contacts/view/' + contactId)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(function(html) {
                            document.getElementById('contactViewContent').innerHTML = html;
                            
                            // Re-initialize event listeners for contact person cards after content is loaded
                            setTimeout(function() {
                                document.querySelectorAll('.contact-person-card').forEach(function(card) {
                                    card.addEventListener('click', function() {
                                        const personId = this.getAttribute('data-contact-id');
                                        viewContactPerson(personId);
                                    });
                                });
                            }, 100);
                        })
                        .catch(function(error) {
                            console.error('Error loading contact:', error);
                            document.getElementById('contactViewContent').innerHTML = 
                                '&lt;div class="alert alert-danger"&gt;Error loading contact details. Please try again.&lt;/div&gt;';
                        });
                }

                function viewContactPerson(contactId) {
                    // Show loading state
                    document.getElementById('contactPersonViewContent').innerHTML = '&lt;div class="text-center p-4"&gt;&lt;div class="spinner-border" role="status"&gt;&lt;/div&gt;&lt;p class="mt-2"&gt;Loading contact person details...&lt;/p&gt;&lt;/div&gt;';
                    
                    fetch('/sales_management/contacts/view-person/' + contactId)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(function(html) {
                            document.getElementById('contactPersonViewContent').innerHTML = html;
                            
                            // Close the contact modal and open person modal
                            if (typeof bootstrap !== 'undefined') {
                                const contactModal = bootstrap.Modal.getInstance(document.getElementById('contactViewModal'));
                                if (contactModal) {
                                    contactModal.hide();
                                }
                                
                                const personModal = new bootstrap.Modal(document.getElementById('contactPersonViewModal'));
                                personModal.show();
                            } else {
                                // Fallback
                                document.getElementById('contactViewModal').style.display = 'none';
                                document.getElementById('contactPersonViewModal').style.display = 'block';
                            }
                        })
                        .catch(function(error) {
                            console.error('Error loading contact person:', error);
                            document.getElementById('contactPersonViewContent').innerHTML = 
                                '&lt;div class="alert alert-danger"&gt;Error loading contact person details. Please try again.&lt;/div&gt;';
                        });
                }

                function closeContactModal() {
                    if (typeof bootstrap !== 'undefined') {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('contactViewModal'));
                        if (modal) modal.hide();
                    } else {
                        document.getElementById('contactViewModal').style.display = 'none';
                    }
                }

                function closeContactPersonModal() {
                    if (typeof bootstrap !== 'undefined') {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('contactPersonViewModal'));
                        if (modal) modal.hide();
                    } else {
                        document.getElementById('contactPersonViewModal').style.display = 'none';
                    }
                }
            </script>
        </t>
    </template>

    <template id="contact_form" name="Contact Creation Form">
        <t t-call="website.layout">
            <t t-set="head">
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
                <style>
                    /* Your existing styles remain the same */
                    .dashboard-sidebar {
                        position: fixed;
                        top: 70px;
                        left: 0;
                        height: calc(100vh - 70px);
                        width: 280px;
                        background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
                        border-right: none;
                        box-shadow: 4px 0 20px rgba(0,0,0,0.1);
                        z-index: 1000;
                        padding-top: 20px;
                        overflow-y: auto;
                        transition: all 0.3s ease;
                    }

                    .dashboard-sidebar .sidebar-header {
                        padding: 0 25px 20px;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                        margin-bottom: 15px;
                    }

                    .dashboard-sidebar .sidebar-header h4 {
                        color: white;
                        font-weight: 600;
                        margin: 0;
                        font-size: 1.2rem;
                    }

                    .dashboard-sidebar .list-group-item {
                        border: none;
                        border-radius: 12px;
                        padding: 16px 20px;
                        margin: 4px 15px;
                        font-weight: 500;
                        color: rgba(255,255,255,0.9);
                        background: transparent;
                        transition: all 0.3s ease;
                        border-left: 3px solid transparent;
                    }

                    .dashboard-sidebar .list-group-item:hover {
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border-left-color: #e74c3c;
                        transform: translateX(5px);
                    }

                    .dashboard-sidebar .list-group-item.active {
                        background: rgba(255,255,255,0.15);
                        color: white;
                        border-left-color: #e74c3c;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }

                    .dashboard-sidebar .list-group-item i {
                        width: 20px;
                        text-align: center;
                        margin-right: 12px;
                        font-size: 1.1rem;
                    }

                    .dashboard-content {
                        margin-left: 300px;
                        padding: 30px;
                        min-height: calc(100vh - 70px);
                        background: #f8fafc;
                    }

                    .card {
                        border: none;
                        border-radius: 16px;
                        box-shadow: 0 4px 25px rgba(0,0,0,0.08);
                        margin-bottom: 25px;
                        overflow: hidden;
                    }

                    .card-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 20px 25px;
                    }

                    .contact-person-widget {
                        border: 1px solid #e9ecef;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        background: white;
                        position: relative;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                        transition: all 0.3s ease;
                    }

                    .contact-person-widget:hover {
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                    }

                    .contact-person-widget .remove-btn {
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        border-radius: 8px;
                    }

                    .contact-wizard {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: none;
                        align-items: center;
                        justify-content: center;
                        z-index: 1050;
                    }

                    .wizard-content {
                        background: white;
                        border-radius: 16px;
                        padding: 30px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }

                    .form-control {
                        border-radius: 10px;
                        border: 2px solid #e9ecef;
                        padding: 12px 16px;
                        transition: all 0.3s ease;
                    }

                    .form-control:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                    }

                    .form-label {
                        font-weight: 600;
                        color: #2c3e50;
                        margin-bottom: 8px;
                    }

                    .section-header {
                        color: #2c3e50;
                        font-weight: 600;
                        margin-bottom: 20px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #3498db;
                    }

                    .btn-primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        border-radius: 10px;
                        padding: 12px 24px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    }

                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                    }

                    /* Success Message Styles */
                    .success-message {
                        background: linear-gradient(135deg, #27ae60, #2ecc71);
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        text-align: center;
                        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
                        display: none;
                        position: fixed;
                        top: 100px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 9999;
                        min-width: 300px;
                    }

                    .success-message i {
                        margin-right: 10px;
                    }

                    /* Search Dropdown Styles */
                    .search-dropdown-container {
                        position: relative;
                    }

                    .search-suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        max-height: 300px;
                        overflow-y: auto;
                        z-index: 1060;
                        border: 1px solid #dee2e6;
                        border-radius: 0.375rem;
                        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                        display: none;
                    }

                    .search-suggestions .list-group-item {
                        border: none;
                        border-bottom: 1px solid #f8f9fa;
                        padding: 12px 16px;
                        cursor: pointer;
                    }

                    .search-suggestions .list-group-item:hover {
                        background-color: #f8f9fa;
                    }

                    .search-suggestions .list-group-item:last-child {
                        border-bottom: none;
                    }

                    .search-dropdown-input {
                        border-radius: 0.375rem !important;
                    }

                    .clear-search-btn {
                        border-radius: 0 0.375rem 0.375rem 0 !important;
                    }

                    @media (max-width: 768px) {
                        .dashboard-sidebar {
                            width: 100%;
                            height: auto;
                            position: relative;
                            top: 0;
                        }
                        
                        .dashboard-content {
                            margin-left: 0;
                            padding: 20px 15px;
                        }
                        
                        .success-message {
                            left: 20px;
                            right: 20px;
                            transform: none;
                            min-width: auto;
                        }
                    }
                </style>
            </t>
            
            <div class="container-fluid">
                <div class="row">
                    <!-- Enhanced Sidebar -->
                    <div class="dashboard-sidebar">
                        <div class="sidebar-header">
                            <h4>Sales Management</h4>
                        </div>
                        <div class="list-group" id="sidebarMenu">
                            <!-- Dashboard - Always visible -->
                            <a href="/sales_management" class="list-group-item list-group-item-action">
                                <i class="fa fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                            
                            <!-- Sales Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_sales_portal">
                                <a href="/sales_management/sales" class="list-group-item list-group-item-action">
                                    <i class="fa fa-briefcase me-2"></i> Sales
                                </a>
                            </t>
                            <!-- Service Portal - Conditionally visible -->
                             <t t-if="request.env.user.use_service_portal">
                                <a href="/sales_management/service" class="list-group-item list-group-item-action">
                                    <i class="fa fa-concierge-bell me-2"></i> Service
                                </a>
                            </t>
                            
                            <!-- Contacts Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_contact_portal">
                                <a href="/sales_management/contacts" class="list-group-item list-group-item-action active">
                                    <i class="fa fa-users me-2"></i> Contacts
                                </a>
                            </t>
                            
                            <!-- Quotation Portal - Conditionally visible -->
                            <t t-if="request.env.user.use_quotation_portal">
                                <a href="/sales_management/quotation" class="list-group-item list-group-item-action">
                                    <i class="fa fa-file-invoice-dollar me-2"></i> Quotation
                                </a>
                            </t>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="dashboard-content col">
                        <!-- Success Message -->
                        <div class="success-message" id="successMessage">
                            <i class="fa fa-check-circle"></i>
                            <strong>Contact Created Successfully</strong>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 class="mb-1">Create Contact</h2>
                                <p class="text-muted mb-0">Add a new contact or company to your portfolio</p>
                            </div>
                            <a href="/sales_management/contacts" class="btn btn-secondary">
                                <i class="fa fa-arrow-left me-2"></i>Back to Contacts
                            </a>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="mb-0">Contact Information</h2>
                            </div>
                            <div class="card-body">
                                <form method="post" action="/sales_management/contacts/submit" class="needs-validation" novalidate="novalidate" id="contactForm">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="redirect_to_list" value="true"/>

                                    <!-- Company Type -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <label class="form-label">Contact Type *</label>
                                            <div class="d-flex gap-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="company_type" id="person" value="person" checked="checked" onchange="toggleContactType()"/>
                                                    <label class="form-check-label fw-bold" for="person">
                                                        <i class="fa fa-user me-2"></i>Person
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="company_type" id="company" value="company" onchange="toggleContactType()"/>
                                                    <label class="form-check-label fw-bold" for="company">
                                                        <i class="fa fa-building me-2"></i>Company
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Basic Information -->
                                    <div class="mb-4">
                                        <h5 class="section-header">Basic Information</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Name *</label>
                                                <input type="text" class="form-control" name="name" required="required" placeholder="Enter full name or company name"/>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" name="email" placeholder="email@example.com"/>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Phone</label>
                                                <input type="text" class="form-control" name="phone" placeholder="+1 (555) 123-4567"/>
                                            </div>
                                            <!-- Dynamic field that changes based on contact type -->
                                            <div class="col-md-6" id="tags-field">
                                                <label class="form-label">Tags</label>
                                                <div id="tags-search-container"></div>
                                            </div>
                                            <!-- Job Title field for person type (hidden by default) -->
                                            <div class="col-md-6" id="job-title-field" style="display: none;">
                                                <label class="form-label">Job Title</label>
                                                <input type="text" class="form-control" name="function" placeholder="Job title"/>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Company Information (for Person type) -->
                                    <div class="mb-4" id="company-info-section">
                                        <h5 class="section-header">Company Information</h5>
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <label class="form-label">Select Company</label>
                                                <div id="company-search-container"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Company Address Information -->
                                    <div class="mb-4">
                                        <h5 class="section-header">Company Address Information</h5>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <label class="form-label">Street</label>
                                                <input type="text" class="form-control" name="street" placeholder="Street address"/>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <label class="form-label">Street 2</label>
                                                <input type="text" class="form-control" name="street2" placeholder="Apartment, suite, unit, etc."/>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-4">
                                                <label class="form-label">City</label>
                                                <input type="text" class="form-control" name="city" placeholder="City"/>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">State</label>
                                                <select class="form-control" name="state_id">
                                                    <option value="">Select State</option>
                                                    <t t-foreach="states" t-as="state">
                                                        <option t-att-value="state.id" t-esc="state.name"/>
                                                    </t>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">ZIP</label>
                                                <input type="text" class="form-control" name="zip" placeholder="ZIP code"/>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Country</label>
                                                <select class="form-control" name="country_id">
                                                    <option value="">Select Country</option>
                                                    <t t-foreach="countries" t-as="country">
                                                        <option t-att-value="country.id" t-esc="country.name"/>
                                                    </t>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contact Persons Section (for Company type) -->
                                    <div class="mb-4" id="contact-persons-section" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="section-header mb-0">Contact Persons</h5>
                                            <button type="button" class="btn btn-outline-primary" onclick="showContactWizard()">
                                                <i class="fa fa-plus me-2"></i>Add Contact Person
                                            </button>
                                        </div>
                                        <div id="contact-persons-container">
                                            <!-- Contact persons will be added here via wizard -->
                                        </div>
                                    </div>

                                    <div class="d-flex gap-3 pt-3 border-top">
                                        <button type="button" class="btn btn-primary px-5" id="submitBtn">
                                            <i class="fa fa-save me-2"></i>Create Contact
                                        </button>
                                        <a href="/sales_management/contacts" class="btn btn-outline-secondary px-4">Cancel</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Person Wizard Modal -->
            <div class="contact-wizard" id="contactWizard">
                <div class="wizard-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Add Contact Person</h4>
                        <button type="button" class="btn-close" onclick="hideContactWizard()"></button>
                    </div>
                    
                    <form id="contactPersonForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="wizard_name" required="required" placeholder="Contact person name"/>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="wizard_email" placeholder="email@example.com"/>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" id="wizard_phone" placeholder="+1 (555) 123-4567"/>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Job Title</label>
                                <input type="text" class="form-control" id="wizard_function" placeholder="Job title"/>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-end pt-3 border-top">
                            <button type="button" class="btn btn-secondary" onclick="hideContactWizard()">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="addContactFromWizard()">Add Contact</button>
                        </div>
                    </form>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
            <![CDATA[
                // Enhanced Search Dropdown Component for Odoo 19
                class SearchDropdown {
                    constructor(config) {
                        this.config = config;
                        this.state = {
                            searchTerm: "",
                            showSuggestions: false,
                            filteredItems: [],
                            selectedItem: null,
                            isLoading: false
                        };
                        this.init();
                    }

                    init() {
                        this.createHTML();
                        this.bindEvents();
                    }

                    createHTML() {
                        const container = this.config.container;
                        const placeholder = this.config.placeholder || 'Search...';
                        const name = this.config.name;
                        
                        container.innerHTML = `
                            <div class="search-dropdown-container position-relative">
                                <div class="input-group">
                                    <input type="text" 
                                        class="form-control search-dropdown-input" 
                                        placeholder="${placeholder}" 
                                        autocomplete="off">
                                    <input type="hidden" name="${name}" class="selected-value">
                                    <button class="btn btn-outline-secondary clear-search-btn" type="button" style="display: none;">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                <div class="search-suggestions" style="display: none;">
                                    <div class="list-group"></div>
                                </div>
                            </div>
                        `;
                        
                        this.elements = {
                            container: container.querySelector('.search-dropdown-container'),
                            input: container.querySelector('.search-dropdown-input'),
                            hiddenInput: container.querySelector('.selected-value'),
                            suggestions: container.querySelector('.search-suggestions'),
                            clearBtn: container.querySelector('.clear-search-btn'),
                            list: container.querySelector('.list-group')
                        };
                    }

                    bindEvents() {
                        const self = this;
                        
                        // Input events
                        this.elements.input.addEventListener('input', function(ev) { 
                            self.onSearchChange(ev); 
                        });
                        
                        this.elements.input.addEventListener('focus', function() { 
                            self.onSearchFocus(); 
                        });
                        
                        // Blur event with delay to allow click on suggestions
                        this.elements.input.addEventListener('blur', function() { 
                            setTimeout(() => {
                                self.hideSuggestions();
                            }, 200);
                        });
                        
                        // Clear button
                        this.elements.clearBtn.addEventListener('click', function() { 
                            self.clearSearch(); 
                        });
                        
                        // Keyboard navigation
                        this.elements.input.addEventListener('keydown', function(ev) {
                            if (ev.key === 'Enter') {
                                ev.preventDefault();
                                if (self.state.filteredItems.length > 0) {
                                    self.onItemSelect(self.state.filteredItems[0]);
                                }
                            } else if (ev.key === 'Escape') {
                                self.hideSuggestions();
                            } else if (ev.key === 'ArrowDown') {
                                ev.preventDefault();
                                self.focusNextItem();
                            } else if (ev.key === 'ArrowUp') {
                                ev.preventDefault();
                                self.focusPreviousItem();
                            }
                        });
                    }

                    async onSearchChange(ev) {
                        const searchTerm = ev.target.value;
                        this.state.searchTerm = searchTerm;
                        
                        // Show/hide clear button
                        this.elements.clearBtn.style.display = searchTerm ? 'block' : 'none';

                        // If field is cleared manually, clear the hidden input
                        if (searchTerm.length === 0) {
                            this.elements.hiddenInput.value = '';
                            await this.loadAllItems();
                            this.showSuggestions();
                        } else if (searchTerm.length >= 1) {
                            await this.loadSuggestions(searchTerm);
                            this.showSuggestions();
                        }
                    }

                    async onSearchFocus() {
                        // Show all items when clicking on empty field
                        if (!this.state.searchTerm) {
                            await this.loadAllItems();
                            this.showSuggestions();
                        } else if (this.state.filteredItems.length > 0) {
                            this.showSuggestions();
                        }
                    }

                    async loadAllItems() {
                        await this.loadSuggestions('');
                    }

                    async loadSuggestions(searchTerm) {
                        if (this.state.isLoading) return;
                        
                        this.state.isLoading = true;
                        this.showLoadingState();
                        
                        try {
                            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                            
                            const response = await fetch(this.config.searchUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': csrfToken
                                },
                                body: JSON.stringify({
                                    jsonrpc: "2.0",
                                    method: "call",
                                    params: {
                                        search_term: searchTerm
                                    }
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            // Handle Odoo JSON-RPC response format
                            if (data.result) {
                                this.state.filteredItems = data.result.items || [];
                            } else if (data.items) {
                                this.state.filteredItems = data.items || [];
                            } else {
                                this.state.filteredItems = [];
                            }
                            
                            this.renderSuggestions();
                            
                        } catch (error) {
                            console.error('Error loading suggestions:', error);
                            this.state.filteredItems = [];
                            this.renderSuggestions();
                        } finally {
                            this.state.isLoading = false;
                        }
                    }

                    showLoadingState() {
                        this.elements.list.innerHTML = '<div class="list-group-item text-center text-muted"><i class="fa fa-spinner fa-spin me-2"></i>Loading...</div>';
                    }

                    renderSuggestions() {
                        const displayField = this.config.displayField || 'name';
                        const secondaryField = this.config.secondaryField;
                        this.elements.list.innerHTML = '';

                        if (this.state.filteredItems.length === 0) {
                            this.elements.list.innerHTML = '<div class="list-group-item text-muted text-center"><i class="fa fa-search me-2"></i>No results found</div>';
                            return;
                        }

                        const self = this;
                        this.state.filteredItems.forEach(function(item, index) {
                            const itemElement = document.createElement('button');
                            itemElement.type = 'button';
                            itemElement.className = 'list-group-item list-group-item-action';
                            itemElement.setAttribute('data-index', index);
                            
                            let secondaryHtml = '';
                            if (secondaryField && item[secondaryField]) {
                                secondaryHtml = '<div class="text-muted small">' + self.escapeHtml(item[secondaryField]) + '</div>';
                            }
                            
                            let typeHtml = '';
                            if (item.type) {
                                typeHtml = '<span class="badge bg-secondary">' + self.escapeHtml(item.type) + '</span>';
                            }
                            
                            itemElement.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">${self.escapeHtml(item[displayField])}</div>
                                        ${secondaryHtml}
                                    </div>
                                    ${typeHtml}
                                </div>
                            `;
                            
                            itemElement.addEventListener('click', function() { 
                                self.onItemSelect(item); 
                            });
                            
                            self.elements.list.appendChild(itemElement);
                        });
                    }

                    onItemSelect(item) {
                        this.state.selectedItem = item;
                        this.state.searchTerm = item[this.config.displayField || 'name'];
                        this.elements.input.value = this.state.searchTerm;
                        this.elements.hiddenInput.value = item.id;
                        this.elements.clearBtn.style.display = 'block';
                        this.hideSuggestions();

                        // Call custom callback if provided
                        if (this.config.onSelect) {
                            this.config.onSelect(item);
                        }
                    }

                    clearSearch() {
                        this.state.searchTerm = "";
                        this.state.selectedItem = null;
                        this.state.filteredItems = [];
                        this.elements.input.value = "";
                        this.elements.hiddenInput.value = "";
                        this.elements.clearBtn.style.display = 'none';
                        this.hideSuggestions();
                        
                        // Focus back on input
                        this.elements.input.focus();

                        // Call custom callback if provided
                        if (this.config.onClear) {
                            this.config.onClear();
                        }
                    }

                    showSuggestions() {
                        this.elements.suggestions.style.display = 'block';
                    }

                    hideSuggestions() {
                        this.elements.suggestions.style.display = 'none';
                    }

                    focusNextItem() {
                        const items = this.elements.list.querySelectorAll('.list-group-item');
                        if (items.length === 0) return;
                        
                        const activeItem = this.elements.list.querySelector('.list-group-item:focus');
                        if (!activeItem) {
                            items[0].focus();
                        } else {
                            const currentIndex = parseInt(activeItem.getAttribute('data-index'));
                            if (currentIndex < items.length - 1) {
                                items[currentIndex + 1].focus();
                            }
                        }
                    }

                    focusPreviousItem() {
                        const items = this.elements.list.querySelectorAll('.list-group-item');
                        if (items.length === 0) return;
                        
                        const activeItem = this.elements.list.querySelector('.list-group-item:focus');
                        if (activeItem) {
                            const currentIndex = parseInt(activeItem.getAttribute('data-index'));
                            if (currentIndex > 0) {
                                items[currentIndex - 1].focus();
                            }
                        }
                    }

                    escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }

                    // Public methods
                    setValue(value) {
                        if (value && value.id) {
                            this.onItemSelect(value);
                        }
                    }

                    getValue() {
                        return this.state.selectedItem;
                    }

                    clear() {
                        this.clearSearch();
                    }
                }

                // Global variables
                let companySearch, tagsSearch;

                // Toggle contact type (Person vs Company)
                function toggleContactType() {
                    const companyType = document.querySelector('input[name="company_type"]:checked').value;
                    const contactPersonsSection = document.getElementById('contact-persons-section');
                    const companyInfoSection = document.getElementById('company-info-section');
                    const tagsField = document.getElementById('tags-field');
                    const jobTitleField = document.getElementById('job-title-field');
                    
                    if (companyType === 'company') {
                        contactPersonsSection.style.display = 'block';
                        companyInfoSection.style.display = 'none';
                        tagsField.style.display = 'block';
                        jobTitleField.style.display = 'none';
                        // Clear company selection when switching to company type
                        if (companySearch) companySearch.clear();
                    } else {
                        contactPersonsSection.style.display = 'none';
                        companyInfoSection.style.display = 'block';
                        tagsField.style.display = 'none';
                        jobTitleField.style.display = 'block';
                    }
                }

                // Show contact wizard modal
                function showContactWizard() {
                    document.getElementById('contactWizard').style.display = 'flex';
                    document.getElementById('contactPersonForm').reset();
                }

                // Hide contact wizard modal
                function hideContactWizard() {
                    document.getElementById('contactWizard').style.display = 'none';
                }

                // Add contact person from wizard
                function addContactFromWizard() {
                    const name = document.getElementById('wizard_name').value;
                    const email = document.getElementById('wizard_email').value;
                    const phone = document.getElementById('wizard_phone').value;
                    const jobTitle = document.getElementById('wizard_function').value;
                    
                    if (!name) {
                        alert('Please enter contact person name');
                        return;
                    }

                    const container = document.getElementById('contact-persons-container');
                    
                    // Create contact person widget
                    const newContact = document.createElement('div');
                    newContact.className = 'contact-person-widget';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-danger btn-sm remove-btn';
                    removeBtn.innerHTML = '<i class="fa fa-trash me-1"></i>Remove';
                    removeBtn.onclick = function() { this.parentElement.remove(); };
                    
                    const row1 = document.createElement('div');
                    row1.className = 'row mb-2';
                    
                    const nameCol = document.createElement('div');
                    nameCol.className = 'col-md-4';
                    nameCol.innerHTML = '<label class="form-label">Name</label>';
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.className = 'form-control';
                    nameInput.name = 'child_name[]';
                    nameInput.value = name;
                    nameInput.readOnly = true;
                    nameCol.appendChild(nameInput);
                    
                    const emailCol = document.createElement('div');
                    emailCol.className = 'col-md-4';
                    emailCol.innerHTML = '<label class="form-label">Email</label>';
                    const emailInput = document.createElement('input');
                    emailInput.type = 'email';
                    emailInput.className = 'form-control';
                    emailInput.name = 'child_email[]';
                    emailInput.value = email;
                    emailInput.readOnly = true;
                    emailCol.appendChild(emailInput);
                    
                    const phoneCol = document.createElement('div');
                    phoneCol.className = 'col-md-4';
                    phoneCol.innerHTML = '<label class="form-label">Phone</label>';
                    const phoneInput = document.createElement('input');
                    phoneInput.type = 'text';
                    phoneInput.className = 'form-control';
                    phoneInput.name = 'child_phone[]';
                    phoneInput.value = phone;
                    phoneInput.readOnly = true;
                    phoneCol.appendChild(phoneInput);
                    
                    row1.appendChild(nameCol);
                    row1.appendChild(emailCol);
                    row1.appendChild(phoneCol);
                    
                    const row2 = document.createElement('div');
                    row2.className = 'row';
                    
                    const functionCol = document.createElement('div');
                    functionCol.className = 'col-md-6';
                    functionCol.innerHTML = '<label class="form-label">Job Title</label>';
                    const functionInput = document.createElement('input');
                    functionInput.type = 'text';
                    functionInput.className = 'form-control';
                    functionInput.name = 'child_function[]';
                    functionInput.value = jobTitle;
                    functionInput.readOnly = true;
                    functionCol.appendChild(functionInput);
                    
                    row2.appendChild(functionCol);
                    
                    newContact.appendChild(removeBtn);
                    newContact.appendChild(row1);
                    newContact.appendChild(row2);
                    
                    container.appendChild(newContact);
                    
                    hideContactWizard();
                }

                // Show success message
                function showSuccessMessage() {
                    const successMessage = document.getElementById('successMessage');
                    successMessage.style.display = 'block';
                    
                    setTimeout(function() {
                        successMessage.style.display = 'none';
                    }, 3000);
                }

                // Submit form
                function submitForm() {
                    const form = document.getElementById('contactForm');
                    const submitBtn = document.getElementById('submitBtn');
                    
                    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Creating...';
                    submitBtn.disabled = true;
                    
                    showSuccessMessage();
                    
                    setTimeout(function() {
                        const tempForm = document.createElement('form');
                        tempForm.method = 'POST';
                        tempForm.action = '/sales_management/contacts/submit';
                        tempForm.style.display = 'none';
                        
                        const formData = new FormData(form);
                        for (let [key, value] of formData.entries()) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = value;
                            tempForm.appendChild(input);
                        }
                        
                        const redirectInput = document.createElement('input');
                        redirectInput.type = 'hidden';
                        redirectInput.name = 'redirect_to_list';
                        redirectInput.value = 'true';
                        tempForm.appendChild(redirectInput);
                        
                        document.body.appendChild(tempForm);
                        tempForm.submit();
                    }, 1500);
                }

                // Load company address
                function loadCompanyAddress(companyId) {
                    if (companyId) {
                        fetch('/sales_management/contacts/get-company-address', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': document.querySelector('input[name="csrf_token"]').value
                            },
                            body: JSON.stringify({
                                jsonrpc: "2.0",
                                method: "call",
                                params: {
                                    company_id: companyId
                                }
                            })
                        })
                        .then(function(response) { return response.json(); })
                        .then(function(data) {
                            const result = data.result || data;
                            
                            if (result.street) document.querySelector('input[name="street"]').value = result.street;
                            if (result.street2) document.querySelector('input[name="street2"]').value = result.street2;
                            if (result.city) document.querySelector('input[name="city"]').value = result.city;
                            if (result.zip) document.querySelector('input[name="zip"]').value = result.zip;
                            if (result.state_id) document.querySelector('select[name="state_id"]').value = result.state_id;
                            if (result.country_id) document.querySelector('select[name="country_id"]').value = result.country_id;
                            
                            // Set tags if available - only for person type
                            const companyType = document.querySelector('input[name="company_type"]:checked').value;
                            if (companyType === 'person' && result.category_id && result.category_id.length > 0) {
                                fetch('/sales_management/search/tags', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRF-TOKEN': document.querySelector('input[name="csrf_token"]').value
                                    },
                                    body: JSON.stringify({
                                        jsonrpc: "2.0",
                                        method: "call",
                                        params: {
                                            search_term: ''
                                        }
                                    })
                                })
                                .then(function(response) { return response.json(); })
                                .then(function(tagData) {
                                    const items = tagData.result ? tagData.result.items : (tagData.items || []);
                                    const tag = items.find(function(t) { return t.id === result.category_id[0]; });
                                    if (tag && tagsSearch) {
                                        tagsSearch.setValue(tag);
                                    }
                                });
                            }
                        })
                        .catch(function(error) {
                            console.error('Error loading company address:', error);
                        });
                    } else {
                        clearAddressFields();
                    }
                }

                // Clear address fields
                function clearAddressFields() {
                    document.querySelector('input[name="street"]').value = '';
                    document.querySelector('input[name="street2"]').value = '';
                    document.querySelector('input[name="city"]').value = '';
                    document.querySelector('input[name="zip"]').value = '';
                    document.querySelector('select[name="state_id"]').value = '';
                    document.querySelector('select[name="country_id"]').value = '';
                    if (tagsSearch) {
                        tagsSearch.clear();
                    }
                }

                // Initialize on DOM ready
                document.addEventListener("DOMContentLoaded", function () {
                    // Initialize Company Search Dropdown
                    const companyContainer = document.getElementById('company-search-container');
                    if (companyContainer) {
                        companySearch = new SearchDropdown({
                            container: companyContainer,
                            placeholder: 'Search for company...',
                            name: 'company_id',
                            searchUrl: '/sales_management/search/companies',
                            displayField: 'name',
                            secondaryField: 'phone',
                            onSelect: function(company) {
                                console.log('Company selected:', company);
                                loadCompanyAddress(company.id);
                            },
                            onClear: function() {
                                console.log('Company cleared');
                                clearAddressFields();
                            }
                        });
                    }

                    // Initialize Tags Search Dropdown
                    const tagsContainer = document.getElementById('tags-search-container');
                    if (tagsContainer) {
                        tagsSearch = new SearchDropdown({
                            container: tagsContainer,
                            placeholder: 'Search for tags...',
                            name: 'category_id',
                            searchUrl: '/sales_management/search/tags',
                            displayField: 'name',
                            onSelect: function(tag) {
                                console.log('Tag selected:', tag);
                            },
                            onClear: function() {
                                console.log('Tag cleared');
                            }
                        });
                    }

                    // Handle form submission
                    const submitBtn = document.getElementById('submitBtn');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            const nameField = document.querySelector('input[name="name"]');
                            if (!nameField.value.trim()) {
                                alert('Please enter a name');
                                nameField.focus();
                                return;
                            }
                            
                            submitForm();
                        });
                    }

                    // Initialize sidebar menu active state
                    const menuItems = document.querySelectorAll("#sidebarMenu a");
                    const currentPath = window.location.pathname;
                    menuItems.forEach(function(item) {
                        item.classList.remove("active");
                        if (item.getAttribute("href") === currentPath) {
                            item.classList.add("active");
                        }
                    });

                    // Initialize contact type visibility
                    toggleContactType();
                });

                // Close wizard when clicking outside
                const contactWizard = document.getElementById('contactWizard');
                if (contactWizard) {
                    contactWizard.addEventListener('click', function(e) {
                        if (e.target === this) {
                            hideContactWizard();
                        }
                    });
                }
            ]]>
            </script>
        </t>
    </template>

    <!-- Add Contact View Template -->
    <template id="contact_view" name="Contact View">
        <div class="contact-view-content">
            <t t-if="contact">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="section-header">Basic Information</h5>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Name</label>
                            <p class="form-control-plaintext" t-esc="contact.name"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <p class="form-control-plaintext">
                                <t t-if="contact.email">
                                    <a t-att-href="'mailto:' + contact.email" t-esc="contact.email"/>
                                </t>
                                <t t-else="">N/A</t>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Phone</label>
                            <p class="form-control-plaintext">
                                <t t-if="contact.phone">
                                    <a t-att-href="'tel:' + contact.phone" t-esc="contact.phone"/>
                                </t>
                                <t t-else="">N/A</t>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Type</label>
                            <p class="form-control-plaintext">
                                <span class="badge" t-att-class="'bg-primary' if contact.is_company else 'bg-success'">
                                    <t t-esc="'Company' if contact.is_company else 'Person'"/>
                                </span>
                            </p>
                        </div>
                        <t t-if="contact.parent_id">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Company</label>
                                <p class="form-control-plaintext" t-esc="contact.parent_id.name"/>
                            </div>
                        </t>
                        <t t-if="contact.function">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Job Title</label>
                                <p class="form-control-plaintext" t-esc="contact.function"/>
                            </div>
                        </t>
                    </div>
                    <div class="col-md-6">
                        <h5 class="section-header">Company Address</h5>
                        <t t-if="contact.street or contact.street2 or contact.city or contact.state_id or contact.zip or contact.country_id">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Street</label>
                                <p class="form-control-plaintext" t-esc="contact.street or 'N/A'"/>
                            </div>
                            <t t-if="contact.street2">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Street 2</label>
                                    <p class="form-control-plaintext" t-esc="contact.street2"/>
                                </div>
                            </t>
                            <div class="mb-3">
                                <label class="form-label fw-bold">City</label>
                                <p class="form-control-plaintext" t-esc="contact.city or 'N/A'"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">State</label>
                                <p class="form-control-plaintext" t-esc="contact.state_id.name if contact.state_id else 'N/A'"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ZIP</label>
                                <p class="form-control-plaintext" t-esc="contact.zip or 'N/A'"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Country</label>
                                <p class="form-control-plaintext" t-esc="contact.country_id.name if contact.country_id else 'N/A'"/>
                            </div>
                        </t>
                        <t t-else="">
                            <p class="text-muted">No address information</p>
                        </t>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="section-header">Tags</h5>
                        <t t-if="contact.category_id">
                            <div class="d-flex flex-wrap gap-2">
                                <t t-foreach="contact.category_id" t-as="tag">
                                    <span class="badge bg-secondary" t-att-value="tag.id" t-esc="tag.name"/>
                                </t>
                            </div>
                        </t>
                        <t t-else="">
                            <p class="text-muted">No tags assigned</p>
                        </t>
                    </div>
                </div>

                <!-- Contact Persons Section for Companies -->
                <t t-if="contact.is_company and child_contacts">
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="section-header">Contact Persons</h5>
                            <div class="row">
                                <t t-foreach="child_contacts" t-as="child">
                                    <div class="col-md-6 mb-3">
                                        <div class="contact-person-card" t-att-data-contact-id="child.id">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-2" t-esc="child.name"/>
                                                    <t t-if="child.function">
                                                        <p class="text-muted mb-1">
                                                            <i class="fa fa-briefcase me-2"></i>
                                                            <span t-esc="child.function"/>
                                                        </p>
                                                    </t>
                                                    <t t-if="child.email">
                                                        <p class="text-muted mb-1">
                                                            <i class="fa fa-envelope me-2"></i>
                                                            <span t-esc="child.email"/>
                                                        </p>
                                                    </t>
                                                    <t t-if="child.phone">
                                                        <p class="text-muted mb-0">
                                                            <i class="fa fa-phone me-2"></i>
                                                            <span t-esc="child.phone"/>
                                                        </p>
                                                    </t>
                                                </div>
                                                <div class="ms-3">
                                                    <i class="fa fa-chevron-right text-muted"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
            <t t-else="">
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    Contact not found or you don't have permission to view this contact.
                </div>
            </t>
        </div>
    </template>

    <template id="contact_person_view" name="Contact Person View">
        <div class="contact-person-view-content">
            <t t-if="contact">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="section-header mb-3">Personal Information</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Name</label>
                            <p class="form-control-plaintext" t-esc="contact.name"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <p class="form-control-plaintext">
                                <t t-if="contact.email">
                                    <a t-att-href="'mailto:' + contact.email" t-esc="contact.email"/>
                                </t>
                                <t t-else="">N/A</t>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Phone</label>
                            <p class="form-control-plaintext">
                                <t t-if="contact.phone">
                                    <a t-att-href="'tel:' + contact.phone" t-esc="contact.phone"/>
                                </t>
                                <t t-else="">N/A</t>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="section-header mb-3">Professional Information</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Job Title</label>
                            <p class="form-control-plaintext" t-esc="contact.function or 'N/A'"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Company</label>
                            <p class="form-control-plaintext" t-esc="contact.parent_id.name or 'N/A'"/>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="section-header mb-3">Company Address Information</h6>
                        <t t-if="contact.street or contact.street2 or contact.city or contact.state_id or contact.zip or contact.country_id">
                            <div class="row">
                                <t t-if="contact.street">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold">Street</label>
                                        <p class="form-control-plaintext" t-esc="contact.street"/>
                                    </div>
                                </t>
                                <t t-if="contact.street2">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold">Street 2</label>
                                        <p class="form-control-plaintext" t-esc="contact.street2"/>
                                    </div>
                                </t>
                                <t t-if="contact.city">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold">City</label>
                                        <p class="form-control-plaintext" t-esc="contact.city"/>
                                    </div>
                                </t>
                                <t t-if="contact.state_id">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold">State</label>
                                        <p class="form-control-plaintext" t-esc="contact.state_id.name"/>
                                    </div>
                                </t>
                                <t t-if="contact.zip">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold">ZIP</label>
                                        <p class="form-control-plaintext" t-esc="contact.zip"/>
                                    </div>
                                </t>
                                <t t-if="contact.country_id">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold">Country</label>
                                        <p class="form-control-plaintext" t-esc="contact.country_id.name"/>
                                    </div>
                                </t>
                            </div>
                        </t>
                        <t t-else="">
                            <p class="text-muted">No address information available</p>
                        </t>
                    </div>
                </div>
            </t>
            <t t-else="">
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    Contact person not found or you don't have permission to view this contact.
                </div>
            </t>
        </div>
    </template>

</odoo>